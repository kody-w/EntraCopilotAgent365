<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Enhanced Multi-User Chat Application with Voice Support" />
  <meta name="theme-color" content="#742774" />
  <title>Chat Application</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #742774;
      --primary-light: #9168b6;
      --primary-dark: #4f1c4f;
      --primary-rgb: 116, 39, 116;
      --secondary: #00bcd4;
      --secondary-light: #4dd0e1;
      --accent: #ff4081;
      --success: #4caf50;
      --error: #f44336;
      --warning: #ff9800;
      --info: #2196f3;

      --gray-10: #faf9f8;
      --gray-20: #f3f2f1;
      --gray-30: #edebe9;
      --gray-40: #e1dfdd;
      --gray-50: #d2d0ce;
      --gray-60: #c8c6c4;
      --gray-80: #605e5c;
      --gray-100: #323130;
      --gray-130: #242424;

      --space-xs: 4px;
      --space-s: 8px;
      --space-m: 16px;
      --space-l: 24px;
      --space-xl: 32px;
      --space-xxl: 48px;

      --radius: 8px;
      --radius-small: 4px;
      --radius-large: 16px;
      --radius-full: 9999px;

      --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.16);

      --header-height: 56px;
      --input-container-height: 80px;
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);

      --transition: all 0.2s ease;
    }

    /* Dark mode variables */
    body.dark {
      --gray-10: #1a1a1a;
      --gray-20: #242424;
      --gray-30: #2d2d2d;
      --gray-40: #373737;
      --gray-50: #424242;
      --gray-60: #4d4d4d;
      --gray-80: #8a8a8a;
      --gray-100: #e0e0e0;
      --gray-130: #f5f5f5;
      --primary-light: #a47cc9;
      --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* Allow text selection globally */
    body,
    div,
    span,
    p,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    code,
    pre {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Only disable selection for interactive elements */
    button,
    .button,
    .fab,
    label,
    .clickable {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      background: var(--gray-10);
      color: var(--gray-100);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Mention Autocomplete Dropdown */
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: var(--shadow-medium);
      z-index: 100;
    }

    body.dark .mention-dropdown {
      background: var(--gray-30);
    }

    .mention-dropdown.active {
      display: block;
      animation: slideUp 0.2s ease-out;
    }

    .mention-item {
      padding: var(--space-m);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--space-m);
      border-bottom: 1px solid var(--gray-20);
    }

    body.dark .mention-item {
      border-bottom-color: var(--gray-40);
    }

    .mention-item:last-child {
      border-bottom: none;
    }

    .mention-item:hover,
    .mention-item.selected {
      background: rgba(var(--primary-rgb), 0.08);
    }

    .mention-item-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .mention-item-info {
      flex: 1;
    }

    .mention-item-name {
      font-weight: 600;
      color: var(--gray-100);
      font-size: 14px;
    }

    .mention-item-url {
      font-size: 12px;
      color: var(--gray-60);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Mention Tag in Messages */
    .mention-tag {
      background: rgba(var(--primary-rgb), 0.15);
      color: var(--primary);
      padding: 2px 8px;
      border-radius: var(--radius-small);
      font-weight: 600;
      display: inline-block;
      margin: 0 2px;
    }

    body.dark .mention-tag {
      background: rgba(var(--primary-rgb), 0.25);
      color: var(--primary-light);
    }

    /* Endpoint Badge - Simplified, less prominent (Strategies 1,4,8) */
    .endpoint-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(var(--primary-rgb), 0.08);
      border-radius: var(--radius);
      font-size: 10px;
      font-weight: 500;
      color: var(--gray-60);
      margin-left: var(--space-xs);
      border: none;
      transition: all 0.15s ease;
    }

    .endpoint-badge:hover {
      background: rgba(var(--primary-rgb), 0.12);
      color: var(--primary);
    }

    .endpoint-badge i {
      font-size: 9px;
      opacity: 0.6;
    }

    body.dark .endpoint-badge {
      background: rgba(255, 255, 255, 0.08);
      color: var(--gray-50);
    }

    body.dark .endpoint-badge:hover {
      background: rgba(var(--primary-rgb), 0.15);
      color: var(--primary-light);
    }

    /* Agent Output Styles */
    .agent-output-wrapper {
      margin: var(--space-m) 0;
      background: rgba(var(--primary-rgb), 0.05);
      border: 1px solid rgba(var(--primary-rgb), 0.15);
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition);
    }

    body.dark .agent-output-wrapper {
      background: rgba(var(--primary-rgb), 0.1);
      border-color: rgba(var(--primary-rgb), 0.2);
    }

    .agent-output-header {
      padding: var(--space-m);
      background: rgba(var(--primary-rgb), 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    body.dark .agent-output-header {
      background: rgba(var(--primary-rgb), 0.15);
    }

    .agent-output-header:hover {
      background: rgba(var(--primary-rgb), 0.12);
    }

    body.dark .agent-output-header:hover {
      background: rgba(var(--primary-rgb), 0.2);
    }

    .agent-output-title {
      display: flex;
      align-items: center;
      gap: var(--space-s);
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .agent-output-title i {
      font-size: 16px;
    }

    .agent-output-toggle {
      background: none;
      border: none;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      padding: 4px;
    }

    .agent-output-toggle:hover {
      color: var(--primary);
    }

    .agent-output-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .agent-output-content.expanded {
      max-height: 1000px;
      overflow-y: auto;
    }

    .agent-output-text {
      padding: var(--space-m);
      font-family: monospace;
      font-size: 13px;
      color: var(--gray-80);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
    }

    body.dark .agent-output-text {
      color: var(--gray-100);
    }

    /* Simple Link Styles */
    .link-wrapper {
      display: inline;
      margin: 0 2px;
    }

    .link-wrapper a {
      color: var(--primary);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .link-wrapper a:hover {
      text-decoration: underline;
      color: var(--primary-light);
    }

    .link-wrapper i {
      font-size: 12px;
    }

    /* Endpoint Management Styles */
    .endpoint-list {
      margin-top: var(--space-m);
    }

    .endpoint-item {
      padding: var(--space-m);
      background: var(--gray-20);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      display: flex;
      align-items: center;
      gap: var(--space-m);
      transition: var(--transition);
    }

    body.dark .endpoint-item {
      background: var(--gray-30);
    }

    .endpoint-item:hover {
      background: var(--gray-30);
    }

    body.dark .endpoint-item:hover {
      background: var(--gray-40);
    }

    .endpoint-item-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .endpoint-item-info {
      flex: 1;
      min-width: 0;
    }

    .endpoint-item-name {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: 2px;
    }

    .endpoint-item-url {
      font-size: 12px;
      color: var(--gray-60);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .endpoint-item-actions {
      display: flex;
      gap: var(--space-s);
    }

    .endpoint-item-action {
      background: var(--gray-30);
      border: none;
      color: var(--gray-80);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-small);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    body.dark .endpoint-item-action {
      background: var(--gray-40);
    }

    .endpoint-item-action:hover {
      background: var(--primary);
      color: white;
    }

    .endpoint-item-action.active {
      background: var(--success);
      color: white;
    }

    /* Settings Import/Export Buttons */
    .settings-import-export {
      display: flex;
      gap: var(--space-m);
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--gray-30);
    }

    .settings-import-export button {
      flex: 1;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.9;
      }

      50% {
        opacity: 0.6;
      }
    }

    /* Login Page */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%);
      padding: var(--space-m);
      animation: fadeIn 0.5s ease-out;
    }

    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: var(--space-xl);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      width: 100%;
      max-width: 420px;
      animation: scaleIn 0.5s ease-out;
    }

    body.dark .login-box {
      background: rgba(36, 36, 36, 0.95);
    }

    .login-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }

    .login-header h1 {
      color: var(--primary);
      font-size: 32px;
      font-weight: 700;
      margin-bottom: var(--space-s);
    }

    .login-header p {
      color: var(--gray-80);
      opacity: 0.8;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: var(--space-l);
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-80);
      margin-bottom: var(--space-s);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      font-size: 16px;
      transition: var(--transition);
      background: var(--gray-20);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    body.dark .form-group input:focus,
    body.dark .form-group select:focus {
      background: var(--gray-30);
    }

    .login-button {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-top: var(--space-m);
    }

    .login-button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .user-list {
      margin-top: var(--space-xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--gray-30);
    }

    .user-list h3 {
      font-size: 16px;
      color: var(--gray-80);
      margin-bottom: var(--space-m);
      font-weight: 600;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-m);
      background: var(--gray-20);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      cursor: pointer;
      transition: var(--transition);
    }

    .user-item:hover {
      background: var(--gray-30);
      transform: translateX(4px);
    }

    /* Main App Container */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--gray-10);
      overflow: hidden;
    }

    /* Header - Flattened, reduced visual weight (Strategies 1,4,8) */
    .header {
      background: var(--primary);
      color: white;
      padding: 0 var(--space-l);
      padding-top: var(--safe-area-top);
      height: calc(var(--header-height) + var(--safe-area-top));
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      z-index: 100;
      flex-shrink: 0;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(255,255,255,0.1);
    }

    body.dark .header {
      background: var(--gray-20);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-m);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      letter-spacing: -0.2px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    /* Header buttons - 44px touch targets (Strategies 2,5) */
    .header-button {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    .header-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .header-button:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.25);
    }

    body.dark .header-button {
      background: rgba(255, 255, 255, 0.1);
    }

    body.dark .header-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    #menu-toggle-header {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .header-button:hover {
      background: var(--gray-20);
      color: var(--primary);
    }

    /* Voice indicator in header */
    .voice-indicator {
      display: none;
      align-items: center;
      gap: var(--space-s);
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      animation: fadeIn 0.3s ease-out;
    }

    .voice-indicator.active {
      display: flex;
    }

    .voice-indicator i {
      font-size: 14px;
      animation: pulse 1.5s infinite;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 85%;
      max-width: 340px;
      background: white;
      box-shadow: var(--shadow-large);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 200;
      overflow-y: auto;
    }

    body.dark .sidebar {
      background: var(--gray-20);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
      z-index: 190;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar-header {
      padding: var(--space-l);
      padding-top: calc(var(--space-l) + var(--safe-area-top));
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sidebar-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .sidebar-tabs {
      display: flex;
      background: var(--gray-10);
      position: sticky;
      top: calc(80px + var(--safe-area-top));
      z-index: 9;
    }

    body.dark .sidebar-tabs {
      background: var(--gray-30);
    }

    .sidebar-tab {
      flex: 1;
      padding: var(--space-m);
      background: none;
      border: none;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      font-size: 15px;
      font-weight: 500;
    }

    .sidebar-tab:hover {
      color: var(--gray-100);
    }

    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .chat-list {
      padding: var(--space-m);
      min-height: 300px;
    }

    .chat-list-empty {
      padding: var(--space-xl);
      text-align: center;
      color: var(--gray-60);
    }

    .chat-item {
      padding: var(--space-m);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      background: var(--gray-10);
    }

    body.dark .chat-item {
      background: var(--gray-30);
    }

    .chat-item:hover {
      background: var(--gray-20);
      transform: translateX(4px);
    }

    body.dark .chat-item:hover {
      background: var(--gray-40);
    }

    .chat-item.active {
      background: rgba(var(--primary-rgb), 0.08);
      border-left: 3px solid var(--primary);
    }

    .chat-item-title {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: var(--space-xs);
      padding-right: 60px;
    }

    .chat-item-preview {
      font-size: 14px;
      color: var(--gray-60);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-item-date {
      font-size: 12px;
      color: var(--gray-60);
      margin-top: var(--space-xs);
    }

    .chat-item-actions {
      position: absolute;
      top: var(--space-m);
      right: var(--space-m);
      display: flex;
      gap: var(--space-xs);
      opacity: 0;
      transition: var(--transition);
    }

    .chat-item:hover .chat-item-actions {
      opacity: 1;
    }

    .chat-item-action {
      background: var(--gray-30);
      border: none;
      color: var(--gray-80);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-small);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .chat-item-action:hover {
      background: var(--primary);
      color: white;
    }

    /* Chat Container - Clean, neutral background (Strategy 8) */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--gray-10);
      position: relative;
    }

    body.dark .chat-container {
      background: var(--gray-10);
    }

    .chat-messages-wrapper {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--space-xl) var(--space-l);
      padding-bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + var(--space-l));
      scroll-behavior: smooth;
    }

    /* Welcome Empty State */
    .welcome-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: var(--space-xxl) var(--space-xl);
      text-align: center;
      animation: welcomeFadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes welcomeFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .welcome-logo {
      width: 88px;
      height: 88px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--space-l);
      box-shadow: 0 8px 32px rgba(var(--primary-rgb), 0.4);
      position: relative;
    }

    .welcome-logo::before {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary-light), var(--primary), var(--primary-dark));
      z-index: -1;
      opacity: 0.5;
      filter: blur(8px);
    }

    .welcome-logo i {
      font-size: 38px;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .welcome-title {
      font-size: 32px;
      font-weight: 800;
      color: var(--gray-100);
      margin-bottom: var(--space-s);
      letter-spacing: -0.5px;
    }

    .welcome-subtitle {
      font-size: 16px;
      color: var(--gray-60);
      margin-bottom: var(--space-xxl);
      max-width: 420px;
      line-height: 1.6;
    }

    .welcome-prompts-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-l);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: var(--space-m);
    }

    .welcome-prompts-title::before,
    .welcome-prompts-title::after {
      content: '';
      height: 1px;
      width: 40px;
      background: linear-gradient(90deg, transparent, var(--gray-40));
    }

    .welcome-prompts-title::after {
      background: linear-gradient(90deg, var(--gray-40), transparent);
    }

    .welcome-prompts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-m);
      width: 100%;
      max-width: 900px;
    }

    .welcome-prompt {
      background: var(--gray-20);
      border: 1px solid var(--gray-30);
      border-radius: var(--radius);
      padding: var(--space-m);
      cursor: pointer;
      transition: var(--transition);
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: var(--space-m);
    }

    .welcome-prompt:hover {
      background: rgba(var(--primary-rgb), 0.08);
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .welcome-prompt-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      background: rgba(var(--primary-rgb), 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .welcome-prompt-icon i {
      font-size: 16px;
      color: var(--primary);
    }

    .welcome-prompt-content {
      flex: 1;
      min-width: 0;
    }

    .welcome-prompt-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .welcome-prompt-text {
      font-size: 14px;
      color: var(--gray-100);
      line-height: 1.4;
    }

    body.dark .welcome-prompt {
      background: var(--gray-30);
      border-color: var(--gray-40);
    }

    body.dark .welcome-prompt:hover {
      background: rgba(var(--primary-rgb), 0.15);
    }

    @media (max-width: 600px) {
      .welcome-prompts {
        grid-template-columns: 1fr;
      }

      .welcome-title {
        font-size: 24px;
      }

      .welcome-logo {
        width: 64px;
        height: 64px;
      }

      .welcome-logo i {
        font-size: 28px;
      }
    }

    /* ========================================
       PROMPT LIBRARY - Power Prompts Modal
       ======================================== */
    .prompt-library-btn {
      position: fixed;
      bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + 160px);
      right: 20px;
      width: 52px;
      height: 52px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .prompt-library-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
    }

    .prompt-library-btn::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: var(--radius-full);
      background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #667eea);
      background-size: 300% 300%;
      animation: shimmer 3s ease infinite;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .prompt-library-btn:hover::before {
      opacity: 1;
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .prompt-library-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .prompt-library-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .prompt-library-container {
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      background: var(--gray-10);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      display: flex;
      flex-direction: column;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s ease;
      overflow: hidden;
    }

    .prompt-library-modal.active .prompt-library-container {
      transform: scale(1) translateY(0);
    }

    .prompt-library-header {
      padding: var(--space-l) var(--space-xl);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .prompt-library-title {
      display: flex;
      align-items: center;
      gap: var(--space-m);
    }

    .prompt-library-title h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .prompt-library-title i {
      font-size: 28px;
    }

    .prompt-library-subtitle {
      opacity: 0.9;
      font-size: 14px;
      margin-top: 4px;
    }

    .prompt-library-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .prompt-library-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .prompt-library-filters {
      padding: var(--space-m) var(--space-xl);
      background: var(--gray-20);
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      gap: var(--space-s);
      flex-wrap: wrap;
    }

    .prompt-filter-btn {
      padding: 8px 16px;
      border-radius: var(--radius-full);
      border: 1px solid var(--gray-40);
      background: var(--gray-10);
      color: var(--gray-80);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .prompt-filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .prompt-filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .prompt-library-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-xl);
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--space-l);
    }

    .prompt-card {
      background: var(--gray-20);
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      padding: var(--space-l);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .prompt-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--card-gradient-start, #667eea), var(--card-gradient-end, #764ba2));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }

    .prompt-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-large);
    }

    .prompt-card:hover::before {
      transform: scaleX(1);
    }

    .prompt-card-header {
      display: flex;
      align-items: flex-start;
      gap: var(--space-m);
      margin-bottom: var(--space-m);
    }

    .prompt-card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--card-gradient-start, #667eea), var(--card-gradient-end, #764ba2));
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .prompt-card-icon i {
      font-size: 20px;
      color: white;
    }

    .prompt-card-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-100);
      margin-bottom: 4px;
    }

    .prompt-card-category {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--primary);
      opacity: 0.8;
    }

    .prompt-card-text {
      font-size: 14px;
      color: var(--gray-80);
      line-height: 1.5;
      margin-bottom: var(--space-m);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .prompt-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .prompt-tag {
      padding: 4px 10px;
      background: rgba(var(--primary-rgb), 0.1);
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 500;
      color: var(--primary);
    }

    .prompt-card-action {
      position: absolute;
      bottom: var(--space-m);
      right: var(--space-m);
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .prompt-card:hover .prompt-card-action {
      opacity: 1;
      transform: scale(1);
    }

    /* ========================================
       GENERATIVE UI TEMPLATES
       ======================================== */
    .gen-ui-container {
      margin-top: var(--space-m);
      animation: fadeIn 0.5s ease;
    }

    /* Email List Template */
    .gen-ui-email-list {
      background: var(--gray-20);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .gen-ui-email-header {
      padding: var(--space-m);
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      gap: var(--space-s);
      font-weight: 600;
    }

    .gen-ui-email-item {
      padding: var(--space-m);
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      align-items: center;
      gap: var(--space-m);
      transition: var(--transition);
    }

    .gen-ui-email-item:hover {
      background: var(--gray-30);
    }

    .gen-ui-email-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .gen-ui-email-content {
      flex: 1;
      min-width: 0;
    }

    .gen-ui-email-subject {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: 2px;
    }

    .gen-ui-email-preview {
      font-size: 13px;
      color: var(--gray-60);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gen-ui-email-priority {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
    }

    .gen-ui-email-priority.high { background: #fee2e2; color: #dc2626; }
    .gen-ui-email-priority.medium { background: #fef3c7; color: #d97706; }
    .gen-ui-email-priority.low { background: #d1fae5; color: #059669; }

    /* Relationship Graph Template */
    .gen-ui-relationship-graph {
      background: var(--gray-20);
      border-radius: var(--radius);
      padding: var(--space-l);
    }

    .gen-ui-graph-header {
      display: flex;
      align-items: center;
      gap: var(--space-s);
      margin-bottom: var(--space-l);
      font-weight: 600;
      color: var(--gray-100);
    }

    .gen-ui-graph-header i {
      color: var(--primary);
    }

    .gen-ui-relationship-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-m);
    }

    .gen-ui-relationship-node {
      background: var(--gray-10);
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      padding: var(--space-m);
      text-align: center;
      transition: var(--transition);
    }

    .gen-ui-relationship-node.thriving { border-color: #10b981; }
    .gen-ui-relationship-node.cooling { border-color: #f59e0b; }
    .gen-ui-relationship-node.at-risk { border-color: #ef4444; }

    .gen-ui-node-avatar {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      margin: 0 auto var(--space-s);
    }

    .gen-ui-node-name {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: 4px;
    }

    .gen-ui-node-role {
      font-size: 12px;
      color: var(--gray-60);
      margin-bottom: var(--space-s);
    }

    .gen-ui-node-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
    }

    .gen-ui-node-status.thriving { background: #d1fae5; color: #059669; }
    .gen-ui-node-status.cooling { background: #fef3c7; color: #d97706; }
    .gen-ui-node-status.at-risk { background: #fee2e2; color: #dc2626; }

    /* Dashboard Template */
    .gen-ui-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-m);
    }

    .gen-ui-dashboard-card {
      background: var(--gray-20);
      border-radius: var(--radius);
      padding: var(--space-l);
      border-left: 4px solid var(--primary);
    }

    .gen-ui-dashboard-label {
      font-size: 12px;
      color: var(--gray-60);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-s);
    }

    .gen-ui-dashboard-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-100);
      margin-bottom: var(--space-s);
    }

    .gen-ui-dashboard-trend {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .gen-ui-dashboard-trend.up { color: #10b981; }
    .gen-ui-dashboard-trend.down { color: #ef4444; }

    /* Timeline Template */
    .gen-ui-timeline {
      background: var(--gray-20);
      border-radius: var(--radius);
      padding: var(--space-l);
    }

    .gen-ui-timeline-header {
      display: flex;
      align-items: center;
      gap: var(--space-s);
      margin-bottom: var(--space-l);
      font-weight: 600;
      color: var(--gray-100);
    }

    .gen-ui-timeline-item {
      display: flex;
      gap: var(--space-m);
      padding-bottom: var(--space-l);
      position: relative;
    }

    .gen-ui-timeline-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 32px;
      bottom: 0;
      width: 2px;
      background: var(--gray-40);
    }

    .gen-ui-timeline-item:last-child::before {
      display: none;
    }

    .gen-ui-timeline-dot {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      z-index: 1;
    }

    .gen-ui-timeline-dot i {
      color: white;
      font-size: 14px;
    }

    .gen-ui-timeline-content {
      flex: 1;
      background: var(--gray-10);
      border-radius: var(--radius);
      padding: var(--space-m);
    }

    .gen-ui-timeline-title {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: 4px;
    }

    .gen-ui-timeline-desc {
      font-size: 13px;
      color: var(--gray-60);
    }

    .gen-ui-timeline-time {
      font-size: 11px;
      color: var(--gray-50);
      margin-top: var(--space-s);
    }

    /* Narrative Template */
    .gen-ui-narrative {
      background: linear-gradient(135deg, var(--gray-20), var(--gray-30));
      border-radius: var(--radius);
      padding: var(--space-xl);
      position: relative;
      overflow: hidden;
    }

    .gen-ui-narrative::before {
      content: '"';
      position: absolute;
      top: -20px;
      left: 20px;
      font-size: 120px;
      color: var(--primary);
      opacity: 0.1;
      font-family: Georgia, serif;
    }

    .gen-ui-narrative-text {
      font-size: 18px;
      line-height: 1.8;
      color: var(--gray-100);
      font-style: italic;
      position: relative;
      z-index: 1;
    }

    .gen-ui-narrative-author {
      margin-top: var(--space-l);
      display: flex;
      align-items: center;
      gap: var(--space-m);
    }

    .gen-ui-narrative-avatar {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .gen-ui-narrative-name {
      font-weight: 600;
      color: var(--gray-100);
    }

    .gen-ui-narrative-role {
      font-size: 13px;
      color: var(--gray-60);
    }

    /* Comparison Template */
    .gen-ui-comparison {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: var(--space-m);
      align-items: stretch;
    }

    .gen-ui-comparison-side {
      background: var(--gray-20);
      border-radius: var(--radius);
      padding: var(--space-l);
    }

    .gen-ui-comparison-side.left {
      border-top: 4px solid #ef4444;
    }

    .gen-ui-comparison-side.right {
      border-top: 4px solid #10b981;
    }

    .gen-ui-comparison-title {
      font-weight: 600;
      margin-bottom: var(--space-m);
      display: flex;
      align-items: center;
      gap: var(--space-s);
    }

    .gen-ui-comparison-vs {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--gray-60);
      font-size: 18px;
    }

    .gen-ui-comparison-item {
      padding: var(--space-s) 0;
      border-bottom: 1px solid var(--gray-30);
      font-size: 14px;
      color: var(--gray-80);
    }

    @media (max-width: 768px) {
      .prompt-library-content {
        grid-template-columns: 1fr;
        padding: var(--space-m);
      }

      .prompt-library-header {
        padding: var(--space-m);
      }

      .prompt-library-title h2 {
        font-size: 18px;
      }

      .gen-ui-comparison {
        grid-template-columns: 1fr;
      }

      .gen-ui-comparison-vs {
        padding: var(--space-s) 0;
      }
    }

    body.dark .prompt-card {
      background: var(--gray-30);
      border-color: var(--gray-40);
    }

    body.dark .gen-ui-email-list,
    body.dark .gen-ui-relationship-graph,
    body.dark .gen-ui-dashboard-card,
    body.dark .gen-ui-timeline,
    body.dark .gen-ui-narrative,
    body.dark .gen-ui-comparison-side {
      background: var(--gray-30);
    }

    /* Messages - Enhanced animations (Cycle 1 - Strategy 2) */
    .message-wrapper {
      margin: var(--space-m) 0;
      animation: messageSlideInBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 85%;
    }

    @keyframes messageSlideInBounce {
      from {
        opacity: 0;
        transform: translateY(12px) scale(0.97);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Hover micro-interaction for assistant messages */
    .message-wrapper.assistant .message-content {
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    .message-wrapper.assistant:hover .message-content {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    body.dark .message-wrapper.assistant:hover .message-content {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    }

    .message-wrapper.user {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-wrapper.assistant {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .message-label {
      font-size: 11px;
      color: var(--gray-50);
      margin-bottom: 4px;
      font-weight: 500;
      padding: 0 var(--space-xs);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .message-label .endpoint-badge {
      text-transform: none;
      letter-spacing: normal;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 15px;
      line-height: 1.6;
      transition: all 0.15s ease;
      position: relative;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      cursor: text;
    }

    .user .message-content {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .assistant .message-content {
      background: white;
      color: var(--gray-100);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--gray-20);
    }

    body.dark .assistant .message-content {
      background: var(--gray-30);
      border-color: var(--gray-40);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    /* Markdown content styling */
    .message-content h1, .message-content h2, .message-content h3 {
      margin-top: var(--space-m);
      margin-bottom: var(--space-s);
      font-weight: 700;
      line-height: 1.3;
    }

    .message-content h3 {
      font-size: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: var(--space-s);
    }

    body.dark .message-content h3 {
      color: var(--primary-light);
    }

    .message-content p {
      margin-bottom: var(--space-s);
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message-content ul, .message-content ol {
      margin: var(--space-s) 0;
      padding-left: var(--space-l);
    }

    .message-content li {
      margin-bottom: 4px;
    }

    .message-content strong {
      font-weight: 600;
      color: var(--gray-130);
    }

    body.dark .message-content strong {
      color: white;
    }

    .message-content hr {
      border: none;
      height: 1px;
      background: var(--gray-30);
      margin: var(--space-m) 0;
    }

    body.dark .message-content hr {
      background: var(--gray-50);
    }

    /* Style links in user messages (white background) */
    .user .message-content a {
      color: white !important;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .user .message-content a:hover {
      opacity: 0.85;
    }

    .assistant .message-content a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }

    .assistant .message-content a:hover {
      border-bottom-color: var(--primary);
    }

    .system-message {
      background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), rgba(var(--primary-rgb), 0.02));
      padding: var(--space-m);
      border-radius: var(--radius);
      margin: var(--space-l) auto;
      width: 90%;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 12px;
      border: 1px solid rgba(var(--primary-rgb), 0.1);
      color: var(--gray-80);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      cursor: text;
    }

    body.dark .system-message {
      background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1), rgba(var(--primary-rgb), 0.05));
      color: var(--gray-100);
    }

    /* Voice message indicator - Clean, subtle */
    .voice-message {
      display: none;
      align-items: center;
      gap: var(--space-s);
      margin-top: var(--space-s);
      padding: 10px 14px;
      background: rgba(var(--primary-rgb), 0.06);
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--gray-80);
      border-left: 2px solid var(--primary);
    }

    .voice-message.active {
      display: flex;
      animation: messageSlideIn 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .voice-message i {
      font-size: 14px;
      color: var(--primary);
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }

    .voice-message span {
      font-style: italic;
      line-height: 1.4;
    }

    body.dark .voice-message {
      background: rgba(var(--primary-rgb), 0.1);
      color: var(--gray-100);
    }

    .message-content pre {
      background: var(--gray-20);
      padding: var(--space-m);
      border-radius: var(--radius);
      overflow-x: auto;
      margin: var(--space-s) 0;
      font-size: 13px;
      position: relative;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    body.dark .message-content pre {
      background: var(--gray-10);
    }

    /* Code block copy button - Cycle 1 Feature */
    .code-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: white;
      border: 1px solid var(--gray-30);
      color: var(--gray-60);
      width: 32px;
      height: 32px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s ease;
      font-size: 13px;
    }

    .message-content pre:hover .code-copy-btn {
      opacity: 1;
    }

    .code-copy-btn:hover {
      background: var(--gray-10);
      color: var(--primary);
      border-color: var(--primary);
    }

    .code-copy-btn.copied {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .code-copy-btn.copied::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: calc(var(--radius) + 4px);
      background: rgba(76, 175, 80, 0.3);
      animation: copyRipple 0.4s ease-out forwards;
    }

    @keyframes copyRipple {
      from { transform: scale(0.8); opacity: 1; }
      to { transform: scale(1.2); opacity: 0; }
    }

    body.dark .code-copy-btn {
      background: var(--gray-30);
      border-color: var(--gray-40);
      color: var(--gray-60);
    }

    body.dark .code-copy-btn:hover {
      background: var(--gray-40);
      color: var(--primary-light);
    }

    .message-content code {
      background: rgba(var(--primary-rgb), 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .user .message-content pre,
    .user .message-content code {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Loading Animation - Simplified, consistent styling */
    .loading {
      display: none !important;
      margin: var(--space-m) 0;
      margin-right: auto;
      max-width: 80px;
      background: white;
      padding: 12px 20px;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      border: 1px solid var(--gray-20);
    }

    body.dark .loading {
      background: var(--gray-30);
      border-color: var(--gray-40);
    }

    .loading.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: 5px;
      animation: messageSlideIn 0.3s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .loading span {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      display: inline-block;
      animation: loadingPulse 1s ease-in-out infinite;
    }

    body.dark .loading span {
      background: var(--primary-light);
    }

    .loading span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .loading span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes loadingPulse {
      0%, 100% {
        transform: scale(0.7);
        opacity: 0.4;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Ensure only one loading indicator at a time */
    .chat-messages .loading+.loading {
      display: none !important;
    }

    /* Input Container - Elevated design (Cycle 1 - Strategy 2) */
    .input-container {
      background: white;
      border-top: none;
      padding: var(--space-m) var(--space-l);
      padding-bottom: calc(var(--space-m) + var(--safe-area-bottom));
      display: flex;
      gap: var(--space-s);
      align-items: flex-end;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      min-height: var(--input-container-height);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.06), 0 -1px 3px rgba(0, 0, 0, 0.04);
    }

    body.dark .input-container {
      background: var(--gray-20);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3), 0 -1px 3px rgba(0, 0, 0, 0.2);
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-30);
      border-radius: 20px;
      font-size: 15px;
      resize: none;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: var(--gray-10);
      min-height: 48px;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.4;
    }

    body.dark .input-field {
      background: var(--gray-30);
      color: var(--gray-100);
      border-color: var(--gray-40);
    }

    .input-field::placeholder {
      color: var(--gray-50);
    }

    .input-field:focus {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    body.dark .input-field:focus {
      background: var(--gray-40);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }

    /* Input buttons - 48px touch targets with micro-interactions */
    .input-button {
      background: var(--primary);
      color: white;
      border: none;
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.15s ease;
      font-size: 18px;
      -webkit-tap-highlight-color: transparent;
    }

    .input-button:hover {
      transform: scale(1.05);
      background: var(--primary-dark);
    }

    .input-button:active {
      transform: scale(0.95);
    }

    .input-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .input-button.secondary {
      background: var(--gray-20);
      color: var(--gray-70);
    }

    .input-button.secondary:hover {
      background: var(--gray-30);
    }

    body.dark .input-button.secondary {
      background: var(--gray-40);
      color: var(--gray-100);
    }

    body.dark .input-button.secondary:hover {
      background: var(--gray-50);
    }

    /* Voice button */
    .voice-button {
      background: linear-gradient(135deg, var(--accent), #e91e63);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 64, 129, 0.3);
    }

    .voice-button:hover {
      box-shadow: 0 6px 20px rgba(255, 64, 129, 0.4);
    }

    .voice-button:hover {
      background: var(--accent);
      transform: scale(1.1);
    }

    .voice-button.active {
      background: var(--error);
      animation: pulse 1.5s infinite;
    }

    /* Image Preview */
    .image-preview-container {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      padding: var(--space-m);
      background: white;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      display: none;
      box-shadow: var(--shadow-medium);
    }

    body.dark .image-preview-container {
      background: var(--gray-30);
    }

    .image-preview-container.active {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    .image-preview {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: var(--radius);
      overflow: hidden;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* Float buttons - 8-agent consensus: 56px primary, 48px secondary, 12px gap */
    .float-buttons {
      position: fixed;
      bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + 12px);
      right: 12px;
      display: flex;
      flex-direction: column-reverse;
      gap: 12px;
      z-index: 80;
    }

    /* Secondary FABs - 48px (WCAG AAA compliant) */
    .fab {
      background: white;
      color: var(--gray-70);
      border: 1px solid var(--gray-20);
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      font-size: 17px;
      -webkit-tap-highlight-color: transparent;
    }

    .fab:hover {
      background: var(--gray-10);
      border-color: var(--gray-30);
      color: var(--gray-100);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
    }

    .fab:active {
      transform: scale(0.95);
    }

    body.dark .fab {
      background: var(--gray-30);
      border-color: var(--gray-40);
      color: var(--gray-80);
    }

    body.dark .fab:hover {
      background: var(--gray-40);
      color: white;
    }

    /* Delete button - de-emphasized */
    .fab.secondary {
      color: var(--gray-50);
    }

    .fab.secondary:hover {
      color: #ef4444;
      border-color: #fecaca;
      background: #fef2f2;
    }

    body.dark .fab.secondary:hover {
      color: #f87171;
      border-color: #7f1d1d;
      background: rgba(239, 68, 68, 0.15);
    }

    /* Prompt Library button */
    .fab.prompt-lib {
      color: var(--primary);
    }

    .fab.prompt-lib:hover {
      color: var(--primary-dark);
      border-color: rgba(var(--primary-rgb), 0.3);
      background: rgba(var(--primary-rgb), 0.05);
    }

    /* Menu button - PRIMARY action, 56px (Material Design standard) */
    .fab.menu {
      width: 56px;
      height: 56px;
      font-size: 20px;
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 3px 8px rgba(var(--primary-rgb), 0.3);
    }

    .fab.menu:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.4);
    }

    body.dark .fab.menu {
      background: var(--primary);
      border-color: var(--primary);
    }

    .fab.menu.active {
      transform: rotate(45deg);
    }

    /* Menu Items */
    .menu-items {
      position: fixed;
      bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + 140px);
      right: 12px;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-large);
      padding: var(--space-s);
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px) scale(0.9);
      transition: var(--transition);
      z-index: 80;
      min-width: 220px;
    }

    body.dark .menu-items {
      background: var(--gray-30);
    }

    .menu-items.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-m);
      padding: 12px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      color: var(--gray-100);
      font-size: 15px;
      font-weight: 500;
    }

    .menu-item:hover {
      background: rgba(var(--primary-rgb), 0.08);
    }

    .menu-item i {
      width: 24px;
      text-align: center;
      color: var(--primary);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--space-m);
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-out;
      position: relative;
    }

    body.dark .modal-content {
      background: var(--gray-20);
    }

    .modal-header {
      padding: var(--space-l);
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    body.dark .modal-header {
      background: var(--gray-20);
    }

    .modal-header h2 {
      font-size: 20px;
      color: var(--gray-100);
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
    }

    .modal-close:hover {
      background: var(--gray-20);
      color: var(--gray-100);
    }

    .modal-body {
      padding: var(--space-l);
    }

    .modal-footer {
      padding: var(--space-l);
      border-top: 1px solid var(--gray-30);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-m);
      position: sticky;
      bottom: 0;
      background: white;
      z-index: 10;
    }

    body.dark .modal-footer {
      background: var(--gray-20);
    }

    .button {
      padding: 10px 20px;
      border-radius: var(--radius);
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: var(--space-s);
    }

    .button-primary {
      background: var(--primary);
      color: white;
    }

    .button-primary:hover {
      background: var(--primary-dark);
    }

    .button-secondary {
      background: var(--gray-20);
      color: var(--gray-100);
    }

    body.dark .button-secondary {
      background: var(--gray-40);
    }

    .button-success {
      background: var(--success);
      color: white;
    }

    .button-success:hover {
      background: #45a049;
    }

    /* Settings */
    .settings-section {
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--gray-30);
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-section h3 {
      font-size: 18px;
      margin-bottom: var(--space-l);
      color: var(--gray-100);
      font-weight: 600;
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-m) 0;
    }

    .settings-item label {
      font-size: 15px;
      color: var(--gray-80);
      font-weight: 500;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
      background: var(--gray-30);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition);
    }

    .toggle-switch.active {
      background: var(--success);
    }

    .toggle-switch::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: var(--radius-full);
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Drop Zone */
    .drop-zone {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(var(--primary-rgb), 0.95);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .drop-zone.active {
      display: flex;
      animation: fadeIn 0.2s ease-out;
    }

    .drop-zone-content {
      text-align: center;
      color: white;
    }

    .drop-zone-content i {
      font-size: 72px;
      margin-bottom: var(--space-l);
    }

    .drop-zone-content p {
      font-size: 24px;
      font-weight: 600;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .message-wrapper {
        max-width: 90%;
      }

      .modal-content {
        margin: 20px;
      }
    }

    /* iOS specific fixes */
    @supports (-webkit-touch-callout: none) {
      .app-container {
        height: -webkit-fill-available;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-20);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-50);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-60);
    }

    /* Focus styles */
    *:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Hidden file inputs */
    input[type="file"] {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Login Page -->
  <div id="login-page" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>Welcome Back</h1>
        <p>Sign in to continue your conversations</p>
      </div>

      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Enter your username" required autocomplete="username"
            autocapitalize="off" />
        </div>

        <button type="submit" class="login-button">Sign In</button>
      </form>

      <div class="user-list">
        <h3>Recent Users</h3>
        <div id="recent-users"></div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="header-button" id="sidebar-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="header-title">
          <span id="current-username">Chat</span>
        </h1>
        <div class="voice-indicator" id="voice-indicator">
          <i class="fas fa-volume-up"></i>
          <span>Speaking...</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-button" id="archive-chat">
          <i class="fas fa-archive"></i>
        </button>
        <button class="header-button" id="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
        <button class="header-button" id="logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Chat Library</h2>
        <button class="input-button" id="new-chat">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="active">Active</button>
        <button class="sidebar-tab" data-tab="archived">Archived</button>
      </div>
      <div class="chat-list" id="chat-list-active"></div>
      <div class="chat-list hidden" id="chat-list-archived"></div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Chat Container -->
    <main class="chat-container">
      <div class="chat-messages-wrapper">
        <div class="chat-messages" id="chat-messages">
          <!-- Loading Indicator will be appended here dynamically -->
        </div>
      </div>
    </main>

    <!-- Input Container -->
    <div class="input-container" id="input-container">
      <button class="input-button secondary" id="upload-image">
        <i class="fas fa-image"></i>
      </button>
      <button class="input-button voice-button" id="voice-toggle">
        <i class="fas fa-microphone"></i>
      </button>
      <div class="input-wrapper">
        <div class="mention-dropdown" id="mention-dropdown"></div>
        <div class="image-preview-container" id="image-preview-container"></div>
        <textarea class="input-field" id="user-input" placeholder="Type a message or @mention an endpoint..." rows="1"></textarea>
      </div>
      <button class="input-button" id="send-button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <!-- Float Buttons - Order: bottom to top (menu, prompt library, delete) -->
    <div class="float-buttons">
      <button class="fab menu" id="menu-toggle" title="Menu">
        <i class="fas fa-plus"></i>
      </button>
      <button class="fab prompt-lib" id="prompt-library-btn-fab" title="Power Prompts">
        <i class="fas fa-bolt"></i>
      </button>
      <button class="fab secondary" id="clear-chat" title="Clear Chat">
        <i class="fas fa-trash"></i>
      </button>
    </div>

    <!-- Menu Items -->
    <div class="menu-items" id="menu-items">
      <div class="menu-item" id="export-chat">
        <i class="fas fa-download"></i>
        <span>Export Chat</span>
      </div>
      <div class="menu-item" id="import-chat">
        <i class="fas fa-upload"></i>
        <span>Import Chat</span>
      </div>
      <div class="menu-item" id="export-all">
        <i class="fas fa-file-archive"></i>
        <span>Export All Data</span>
      </div>
      <div class="menu-item" id="import-all">
        <i class="fas fa-file-import"></i>
        <span>Import Data</span>
      </div>
      <div class="menu-item" id="time-machine">
        <i class="fas fa-history"></i>
        <span>Time Machine</span>
      </div>
      <div class="menu-item" id="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </div>
    </div>

    <!-- Prompt Library Modal -->
    <div class="prompt-library-modal" id="prompt-library-modal">
      <div class="prompt-library-container">
        <div class="prompt-library-header">
          <div class="prompt-library-title">
            <i class="fas fa-bolt"></i>
            <div>
              <h2>Power Prompts Library</h2>
              <div class="prompt-library-subtitle">Mind-blowing prompts for simulated M365 integration</div>
            </div>
          </div>
          <button class="prompt-library-close" id="prompt-library-close">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="prompt-library-filters">
          <button class="prompt-filter-btn active" data-filter="all">All Prompts</button>
          <button class="prompt-filter-btn" data-filter="email">Email Intelligence</button>
          <button class="prompt-filter-btn" data-filter="relationships">Relationships</button>
          <button class="prompt-filter-btn" data-filter="calendar">Calendar & Time</button>
          <button class="prompt-filter-btn" data-filter="analytics">Analytics</button>
          <button class="prompt-filter-btn" data-filter="self">Self-Awareness</button>
        </div>
        <div class="prompt-library-content" id="prompt-library-content">
          <!-- Prompt cards will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- Drop Zone -->
    <div class="drop-zone" id="drop-zone">
      <div class="drop-zone-content">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Drop files here to import</p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" id="settings-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Settings Import/Export -->
        <div class="settings-import-export">
          <button class="button button-secondary" id="export-settings">
            <i class="fas fa-download"></i>
            Export Settings
          </button>
          <button class="button button-secondary" id="import-settings">
            <i class="fas fa-upload"></i>
            Import Settings
          </button>
        </div>

        <div class="settings-section">
          <h3>Appearance</h3>
          <div class="settings-item">
            <label for="dark-mode-toggle">Dark Mode</label>
            <div class="toggle-switch" id="dark-mode-toggle"></div>
          </div>
        </div>
        <div class="settings-section">
          <h3>Sound & Voice</h3>
          <div class="settings-item">
            <label for="sound-toggle">Enable Sound Effects</label>
            <div class="toggle-switch" id="sound-toggle"></div>
          </div>
          <div class="settings-item">
            <label for="voice-enabled-toggle">Enable Voice Response</label>
            <div class="toggle-switch" id="voice-enabled-toggle"></div>
          </div>
          <div class="settings-item">
            <label for="auto-speak-toggle">Auto-speak Responses</label>
            <div class="toggle-switch" id="auto-speak-toggle"></div>
          </div>
          <div class="form-group" style="margin-top: 16px">
            <label for="azure-tts-key">Azure TTS API Key</label>
            <input type="password" id="azure-tts-key" placeholder="Enter your Azure TTS API key" />
          </div>
          <div class="form-group">
            <label for="tts-voice-select">TTS Voice</label>
            <select id="tts-voice-select" style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid var(--gray-40);
                  border-radius: 4px;
                ">
              <option value="en-US-JennyNeural">Jenny (Female)</option>
              <option value="en-US-GuyNeural">Guy (Male)</option>
              <option value="en-US-AriaNeural">Aria (Female)</option>
              <option value="en-US-DavisNeural">Davis (Male)</option>
              <option value="en-US-AmberNeural">Amber (Female)</option>
              <option value="en-US-JasonNeural">Jason (Male)</option>
              <option value="en-GB-SoniaNeural">
                Sonia (British Female)
              </option>
              <option value="en-GB-RyanNeural">Ryan (British Male)</option>
            </select>
          </div>
        </div>
        <div class="settings-section">
          <h3>API Endpoints</h3>
          <div class="endpoint-list" id="endpoint-list"></div>
          <button class="button button-primary" id="add-endpoint" style="width: 100%; margin-top: 16px;">
            <i class="fas fa-plus"></i>
            Add Endpoint
          </button>
        </div>
        <div class="settings-section">
          <h3>Data Management</h3>
          <button class="button button-secondary" id="clear-all-data">
            <i class="fas fa-trash-alt"></i>
            Clear All Data
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" id="cancel-settings">
          Cancel
        </button>
        <button class="button button-success" id="save-all-settings">
          <i class="fas fa-save"></i>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Endpoint Modal -->
  <div class="modal" id="endpoint-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="endpoint-modal-title">Add Endpoint</h2>
        <button class="modal-close" id="endpoint-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="endpoint-name">Endpoint Name</label>
          <input type="text" id="endpoint-name" placeholder="e.g., Production Bot" />
        </div>
        <div class="form-group">
          <label for="endpoint-url">Azure Function URL</label>
          <input type="text" id="endpoint-url" placeholder="https://your-function.azurewebsites.net/api/..." />
        </div>
        <div class="form-group">
          <label for="endpoint-key">Function Key</label>
          <input type="text" id="endpoint-key" placeholder="Your function key" />
        </div>
        <div class="form-group">
          <label for="endpoint-guid">User GUID</label>
          <input type="text" id="endpoint-guid" placeholder="c0p110t0-aaaa-bbbb-cccc-123456789abc" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" id="cancel-endpoint">
          Cancel
        </button>
        <button class="button button-success" id="save-endpoint">
          <i class="fas fa-save"></i>
          Save Endpoint
        </button>
      </div>
    </div>
  </div>

  <!-- Time Machine Modal -->
  <div class="modal" id="time-machine-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Time Machine</h2>
        <button class="modal-close" id="time-machine-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <p>Replay the current conversation</p>
        </div>
        <div class="text-center">
          <button class="button button-primary" id="time-machine-start">
            <i class="fas fa-play"></i> Start Replay
          </button>
        </div>
        <div class="hidden" id="time-machine-controls">
          <div class="text-center">
            <span id="time-machine-progress">0 / 0</span>
          </div>
          <div class="text-center" style="margin-top: 20px;">
            <button class="button button-secondary" id="time-machine-prev">
              <i class="fas fa-step-backward"></i>
            </button>
            <button class="button button-primary" id="time-machine-play">
              <i class="fas fa-play"></i>
            </button>
            <button class="button button-secondary" id="time-machine-next">
              <i class="fas fa-step-forward"></i>
            </button>
            <button class="button button-secondary" id="time-machine-stop">
              <i class="fas fa-stop"></i>
            </button>
          </div>
          <div class="text-center" style="margin-top: 20px;">
            <button class="button button-success" id="time-machine-branch">
              <i class="fas fa-code-branch"></i> Continue from Here
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="image-upload-input" accept="image/*" />
  <input type="file" id="chat-import-input" accept=".json" />
  <input type="file" id="data-import-input" accept=".json" />
  <input type="file" id="settings-import-input" accept=".json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

  <script>
    // Global state management
    class AppState {
      constructor() {
        this.currentUser = null;
        this.currentChatId = null;
        this.users = this.loadUsers();
        this.chats = this.loadChats();
        this.settings = this.loadSettings();
        this.endpoints = this.loadEndpoints();
        this.activeEndpointId = null;
      }

      loadUsers() {
        const users = localStorage.getItem("chatAppUsers");
        return users ? JSON.parse(users) : {};
      }

      loadChats() {
        const chats = localStorage.getItem("chatAppChats");
        return chats ? JSON.parse(chats) : {};
      }

      loadSettings() {
        const settings = localStorage.getItem("chatAppSettings");
        return settings
          ? JSON.parse(settings)
          : {
            theme: "dark",
            soundEnabled: false,
            voiceEnabled: true,
            autoSpeak: false,
            azureTTSKey: "",
            azureRegion: "eastus2",
            ttsVoiceName: "en-US-JennyNeural",
          };
      }

      loadEndpoints() {
        const endpoints = localStorage.getItem("chatAppEndpoints");
        const defaultEndpoints = {
          'default': {
            id: 'default',
            name: 'Default Bot',
            url: "https://effective-bassoon-wvrjj9qrxvcg6vr-7071.app.github.dev/api/businessinsightbot_function",
            key: "",
            guid: "c0p110t0-aaaa-bbbb-cccc-123456789abc",
            active: true
          }
        };
        return endpoints ? JSON.parse(endpoints) : defaultEndpoints;
      }

      saveUsers() {
        localStorage.setItem("chatAppUsers", JSON.stringify(this.users));
      }

      saveChats() {
        localStorage.setItem("chatAppChats", JSON.stringify(this.chats));
      }

      saveSettings() {
        localStorage.setItem(
          "chatAppSettings",
          JSON.stringify(this.settings)
        );
      }

      saveEndpoints() {
        localStorage.setItem("chatAppEndpoints", JSON.stringify(this.endpoints));
      }

      createUser(username) {
        const userId = this.generateGuid();
        const user = {
          id: userId,
          username: username,
          createdAt: new Date().toISOString(),
          lastActive: new Date().toISOString(),
          chats: [],
        };
        this.users[userId] = user;
        this.saveUsers();
        return user;
      }

      createChat(userId, title = "New Chat") {
        const chatId = this.generateGuid();
        const chat = {
          id: chatId,
          userId: userId,
          title: title,
          messages: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          archived: false,
        };

        if (!this.chats[userId]) {
          this.chats[userId] = {};
        }

        this.chats[userId][chatId] = chat;
        this.users[userId].chats.push(chatId);
        this.users[userId].lastActive = new Date().toISOString();

        this.saveChats();
        this.saveUsers();

        return chat;
      }

      createBranchChat(userId, sourceChat, upToIndex) {
        const branchTitle = `${sourceChat.title} (Branch from message ${upToIndex + 1})`;
        const branchChat = this.createChat(userId, branchTitle);

        branchChat.messages = sourceChat.messages.slice(0, upToIndex + 1).map(msg => ({...msg}));
        branchChat.updatedAt = new Date().toISOString();

        this.saveChats();
        return branchChat;
      }

      updateChat(userId, chatId, updates) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          Object.assign(this.chats[userId][chatId], updates);
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      getActiveChats(userId) {
        if (!this.chats[userId]) return [];
        return Object.values(this.chats[userId])
          .filter((chat) => !chat.archived)
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }

      getArchivedChats(userId) {
        if (!this.chats[userId]) return [];
        return Object.values(this.chats[userId])
          .filter((chat) => chat.archived)
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }

      archiveChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          this.chats[userId][chatId].archived = true;
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      unarchiveChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          this.chats[userId][chatId].archived = false;
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      deleteChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          delete this.chats[userId][chatId];
          const userChatIndex = this.users[userId].chats.indexOf(chatId);
          if (userChatIndex > -1) {
            this.users[userId].chats.splice(userChatIndex, 1);
          }
          this.saveChats();
          this.saveUsers();
        }
      }

      addEndpoint(name, url, key, guid) {
        const id = this.generateGuid();
        this.endpoints[id] = {
          id: id,
          name: name,
          url: url,
          key: key,
          guid: guid || "c0p110t0-aaaa-bbbb-cccc-123456789abc",
          active: Object.keys(this.endpoints).length === 0
        };
        this.saveEndpoints();
        return this.endpoints[id];
      }

      updateEndpoint(id, updates) {
        if (this.endpoints[id]) {
          Object.assign(this.endpoints[id], updates);
          this.saveEndpoints();
        }
      }

      deleteEndpoint(id) {
        if (this.endpoints[id]) {
          delete this.endpoints[id];
          this.saveEndpoints();
        }
      }

      setActiveEndpoint(id) {
        Object.values(this.endpoints).forEach(endpoint => {
          endpoint.active = endpoint.id === id;
        });
        this.activeEndpointId = id;
        this.saveEndpoints();
      }

      getActiveEndpoint() {
        return Object.values(this.endpoints).find(e => e.active) || Object.values(this.endpoints)[0];
      }

      getEndpointById(id) {
        return this.endpoints[id];
      }

      exportAllData() {
        return {
          users: this.users,
          chats: this.chats,
          settings: this.settings,
          endpoints: this.endpoints,
          azureTTSKey: this.settings.azureTTSKey || "",
          azureRegion: this.settings.azureRegion || "eastus2",
          ttsVoiceName: this.settings.ttsVoiceName || "en-US-JennyNeural",
          exportDate: new Date().toISOString(),
          version: "1.0",
        };
      }

      importAllData(data) {
        // Smart merge for users
        if (data.users) {
          Object.entries(data.users).forEach(([userId, user]) => {
            if (this.users[userId]) {
              // Merge user data, update lastActive
              this.users[userId] = {
                ...this.users[userId],
                ...user,
                chats: [...new Set([...(this.users[userId].chats || []), ...(user.chats || [])])]
              };
            } else {
              this.users[userId] = user;
            }
          });
        }

        // Smart merge for chats
        if (data.chats) {
          Object.entries(data.chats).forEach(([userId, userChats]) => {
            if (!this.chats[userId]) {
              this.chats[userId] = {};
            }
            Object.entries(userChats).forEach(([chatId, chat]) => {
              if (this.chats[userId][chatId]) {
                // Merge messages, dedupe by timestamp
                const existingMsgs = this.chats[userId][chatId].messages || [];
                const newMsgs = chat.messages || [];
                const msgMap = new Map();
                [...existingMsgs, ...newMsgs].forEach(msg => {
                  const key = `${msg.timestamp}-${msg.role}`;
                  if (!msgMap.has(key)) msgMap.set(key, msg);
                });
                this.chats[userId][chatId] = {
                  ...this.chats[userId][chatId],
                  ...chat,
                  messages: Array.from(msgMap.values()).sort((a, b) =>
                    new Date(a.timestamp) - new Date(b.timestamp)
                  )
                };
              } else {
                this.chats[userId][chatId] = chat;
              }
            });
          });
        }

        // Merge settings
        if (data.settings) {
          this.settings = { ...this.settings, ...data.settings };
        }

        // Smart merge for endpoints
        if (data.endpoints) {
          Object.entries(data.endpoints).forEach(([id, endpoint]) => {
            if (this.endpoints[id]) {
              this.endpoints[id] = { ...this.endpoints[id], ...endpoint };
            } else {
              this.endpoints[id] = endpoint;
            }
          });
        }

        // Handle RAPPID top-level TTS fields
        if (data.azureTTSKey !== undefined && data.azureTTSKey !== "") {
          this.settings.azureTTSKey = data.azureTTSKey;
        }
        if (data.azureRegion !== undefined && data.azureRegion !== "") {
          this.settings.azureRegion = data.azureRegion;
        }
        if (data.ttsVoiceName !== undefined && data.ttsVoiceName !== "") {
          this.settings.ttsVoiceName = data.ttsVoiceName;
        }

        this.saveUsers();
        this.saveChats();
        this.saveSettings();
        this.saveEndpoints();
      }

      exportSettings() {
        // RAPPID-compatible settings export
        return {
          rappid: true,
          backupType: "RAPPID Settings Backup",
          endpoints: this.endpoints,
          azureTTSKey: this.settings.azureTTSKey || "",
          azureRegion: this.settings.azureRegion || "eastus2",
          ttsVoiceName: this.settings.ttsVoiceName || "en-US-JennyNeural",
          exportDate: new Date().toISOString(),
          version: "1.0"
        };
      }

      importSettings(settingsData) {
        // Handle RAPPID format
        if (settingsData.azureTTSKey !== undefined) {
          this.settings.azureTTSKey = settingsData.azureTTSKey;
        }
        if (settingsData.azureRegion !== undefined) {
          this.settings.azureRegion = settingsData.azureRegion;
        }
        if (settingsData.ttsVoiceName !== undefined) {
          this.settings.ttsVoiceName = settingsData.ttsVoiceName;
        }

        // Smart merge endpoints
        if (settingsData.endpoints !== undefined) {
          Object.entries(settingsData.endpoints).forEach(([id, endpoint]) => {
            if (this.endpoints[id]) {
              // Merge individual endpoint properties
              this.endpoints[id] = { ...this.endpoints[id], ...endpoint };
            } else {
              // Add new endpoint
              this.endpoints[id] = endpoint;
            }
          });

          // Ensure only one endpoint is active (from imported data)
          const importedActive = Object.values(settingsData.endpoints).find(e => e.active);
          if (importedActive) {
            Object.keys(this.endpoints).forEach(id => {
              this.endpoints[id].active = (id === importedActive.id);
            });
          }

          this.saveEndpoints();
        }

        this.saveSettings();
      }

      clearAllData() {
        localStorage.removeItem("chatAppUsers");
        localStorage.removeItem("chatAppChats");
        localStorage.removeItem("chatAppSettings");
        localStorage.removeItem("chatAppEndpoints");
        localStorage.removeItem("lastUserId");

        this.users = {};
        this.chats = {};
        this.settings = {
          theme: "dark",
          soundEnabled: false,
          voiceEnabled: true,
          autoSpeak: false,
          azureTTSKey: "",
          azureRegion: "eastus2",
          ttsVoiceName: "en-US-JennyNeural",
        };
        this.endpoints = {
          'default': {
            id: 'default',
            name: 'Default Bot',
            url: "",
            key: "",
            guid: "c0p110t0-aaaa-bbbb-cccc-123456789abc",
            active: true
          }
        };
      }

      generateGuid() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }
    }

    // Sound Manager
    class SoundManager {
      constructor() {
        this.audioContext = null;
        this.enabled = false;
      }

      init() {
        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
      }

      setEnabled(enabled) {
        this.enabled = enabled;
        if (enabled) this.init();
      }

      async playSound(frequency = 440, duration = 0.1, type = "sine") {
        if (!this.enabled || !this.audioContext) return;

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = type;

        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          this.audioContext.currentTime + duration
        );

        oscillator.start(this.audioContext.currentTime);
        oscillator.stop(this.audioContext.currentTime + duration);
      }

      playSendSound() {
        this.playSound(523.25, 0.1);
      }

      playReceiveSound() {
        this.playSound(659.25, 0.15);
      }

      playNotificationSound() {
        this.playSound(880, 0.2);
      }
    }

    // Voice Manager
    class VoiceManager {
      constructor() {
        this.synthesis = window.speechSynthesis;
        this.recognition = null;
        this.enabled = true;
        this.autoSpeak = false;
        this.isListening = false;
        this.isSpeaking = false;
        this.azureKey = "";
        this.azureRegion = "eastus2";
        this.voiceName = "en-US-JennyNeural";
        this.isSdkLoaded = false;
        this.speechSynthesizer = null;
        this.maxCharacters = 5000;

        this.initSpeechRecognition();
        this.loadSpeechSdk();
      }

      loadSpeechSdk() {
        if (window.SpeechSDK) {
          this.isSdkLoaded = true;
          return;
        }

        const script = document.createElement("script");
        script.src = "https://aka.ms/csspeech/jsbrowserpackageraw";
        script.async = true;
        script.onload = () => {
          console.log("Microsoft Speech SDK loaded");
          this.isSdkLoaded = true;
        };
        script.onerror = () => {
          console.error("Failed to load Microsoft Speech SDK");
        };

        document.body.appendChild(script);
      }

      initSpeechRecognition() {
        if (
          "webkitSpeechRecognition" in window ||
          "SpeechRecognition" in window
        ) {
          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = false;
          this.recognition.interimResults = true;
          this.recognition.lang = "en-US";

          this.recognition.onstart = () => {
            this.isListening = true;
            document.getElementById("voice-toggle").classList.add("active");
          };

          this.recognition.onend = () => {
            this.isListening = false;
            document
              .getElementById("voice-toggle")
              .classList.remove("active");
          };

          this.recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            this.isListening = false;
            document
              .getElementById("voice-toggle")
              .classList.remove("active");
          };
        }
      }

      setEnabled(enabled) {
        this.enabled = enabled;
      }

      setAutoSpeak(autoSpeak) {
        this.autoSpeak = autoSpeak;
      }

      setAzureKey(key) {
        this.azureKey = key;
      }

      setVoiceName(voiceName) {
        this.voiceName = voiceName;
      }

      async speak(text) {
        if (!this.enabled || !text || this.isSpeaking) return;

        this.stopSpeaking();

        const cleanText = this.cleanTextForSpeech(text);

        if (this.azureKey && this.isSdkLoaded && window.SpeechSDK) {
          await this.speakWithAzure(cleanText);
        } else {
          await this.speakWithBrowser(cleanText);
        }
      }

      async speakWithAzure(text) {
        try {
          const truncatedText =
            text.length > this.maxCharacters
              ? text.substring(0, this.maxCharacters) +
              "... (text truncated for speech)"
              : text;

          const speechConfig = window.SpeechSDK.SpeechConfig.fromSubscription(
            this.azureKey,
            this.azureRegion
          );
          speechConfig.speechSynthesisVoiceName = this.voiceName;

          const audioConfig =
            window.SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
          this.speechSynthesizer = new window.SpeechSDK.SpeechSynthesizer(
            speechConfig,
            audioConfig
          );

          this.isSpeaking = true;
          document.getElementById("voice-indicator").classList.add("active");

          await new Promise((resolve, reject) => {
            this.speechSynthesizer.speakTextAsync(
              truncatedText,
              (result) => {
                if (
                  result.reason ===
                  window.SpeechSDK.ResultReason.SynthesizingAudioCompleted
                ) {
                  console.log("Azure TTS synthesis completed");
                  this.isSpeaking = false;
                  document
                    .getElementById("voice-indicator")
                    .classList.remove("active");

                  if (this.speechSynthesizer) {
                    this.speechSynthesizer.close();
                    this.speechSynthesizer = null;
                  }
                  resolve();
                } else {
                  console.error(
                    `Speech synthesis canceled, reason: ${result.reason}`
                  );
                  let errorDetails = "";

                  if (
                    result.reason === window.SpeechSDK.ResultReason.Canceled
                  ) {
                    const cancellationDetails =
                      window.SpeechSDK.CancellationDetails.fromResult(result);
                    errorDetails = `Cancellation reason: ${cancellationDetails.reason}`;

                    if (
                      cancellationDetails.reason ===
                      window.SpeechSDK.CancellationReason.Error
                    ) {
                      errorDetails += `, Error details: ${cancellationDetails.errorDetails}`;
                    }
                  }

                  if (this.speechSynthesizer) {
                    this.speechSynthesizer.close();
                    this.speechSynthesizer = null;
                  }

                  this.isSpeaking = false;
                  document
                    .getElementById("voice-indicator")
                    .classList.remove("active");
                  reject(
                    new Error(`Speech synthesis failed. ${errorDetails}`)
                  );
                }
              },
              (error) => {
                console.error("Azure TTS error:", error);

                if (this.speechSynthesizer) {
                  this.speechSynthesizer.close();
                  this.speechSynthesizer = null;
                }

                this.isSpeaking = false;
                document
                  .getElementById("voice-indicator")
                  .classList.remove("active");
                reject(error);
              }
            );
          });
        } catch (error) {
          console.error("Azure TTS error:", error);
          this.isSpeaking = false;
          document
            .getElementById("voice-indicator")
            .classList.remove("active");
          await this.speakWithBrowser(text);
        }
      }

      async speakWithBrowser(text) {
        return new Promise((resolve, reject) => {
          try {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            const voices = this.synthesis.getVoices();
            const preferredVoice =
              voices.find(
                (voice) =>
                  voice.name.includes("Microsoft") ||
                  voice.name.includes("Google") ||
                  voice.name.includes("Natural")
              ) || voices[0];

            if (preferredVoice) {
              utterance.voice = preferredVoice;
            }

            utterance.onstart = () => {
              this.isSpeaking = true;
              document
                .getElementById("voice-indicator")
                .classList.add("active");
            };

            utterance.onend = () => {
              this.isSpeaking = false;
              document
                .getElementById("voice-indicator")
                .classList.remove("active");
              resolve();
            };

            utterance.onerror = (error) => {
              this.isSpeaking = false;
              document
                .getElementById("voice-indicator")
                .classList.remove("active");
              reject(error);
            };

            this.synthesis.speak(utterance);
          } catch (error) {
            this.isSpeaking = false;
            document
              .getElementById("voice-indicator")
              .classList.remove("active");
            reject(error);
          }
        });
      }

      stopSpeaking() {
        if (this.speechSynthesizer) {
          try {
            this.speechSynthesizer.close();
          } catch (e) {
            console.warn("Error closing speech synthesizer:", e);
          }
          this.speechSynthesizer = null;
        }

        if (window.speechSynthesis) {
          try {
            window.speechSynthesis.cancel();
          } catch (e) {
            console.warn("Error canceling speech synthesis:", e);
          }
        }

        this.isSpeaking = false;
        document.getElementById("voice-indicator").classList.remove("active");
      }

      cleanTextForSpeech(text) {
        let cleanText = text.replace(/<[^>]*>/g, " ");

        cleanText = cleanText
          .replace(/\*\*([^*]+)\*\*/g, "$1")
          .replace(/\*([^*]+)\*/g, "$1")
          .replace(/`([^`]+)`/g, "$1")
          .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
          .replace(/#{1,6}\s+([^\n]+)/g, "$1")
          .replace(/```[\s\S]*?```/g, "")
          .replace(/\n/g, " ")
          .replace(/\s+/g, " ")
          .trim();

        return cleanText;
      }

      startListening(callback) {
        if (!this.recognition || this.isListening) return;

        this.recognition.onresult = (event) => {
          const last = event.results.length - 1;
          const transcript = event.results[last][0].transcript;

          if (event.results[last].isFinal) {
            callback(transcript);
          }
        };

        this.recognition.start();
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
        }
      }

      toggleListening(callback) {
        if (this.isListening) {
          this.stopListening();
        } else {
          this.startListening(callback);
        }
      }
    }

    // Time Machine
    class TimeMachine {
      constructor() {
        this.messages = [];
        this.currentIndex = 0;
        this.isPlaying = false;
        this.playInterval = null;
        this.sourceChat = null;
      }

      init(messages, sourceChat) {
        this.messages = messages;
        this.currentIndex = 0;
        this.isPlaying = false;
        this.sourceChat = sourceChat;
        this.updateProgress();
      }

      play() {
        if (this.isPlaying) return;
        this.isPlaying = true;

        this.playInterval = setInterval(() => {
          if (this.currentIndex >= this.messages.length - 1) {
            this.pause();
            return;
          }
          this.next();
        }, 1500);

        this.updatePlayButton();
      }

      pause() {
        this.isPlaying = false;
        if (this.playInterval) {
          clearInterval(this.playInterval);
          this.playInterval = null;
        }
        this.updatePlayButton();
      }

      next() {
        if (this.currentIndex < this.messages.length - 1) {
          this.currentIndex++;
          this.displayUpToIndex();
          this.updateProgress();
        }
      }

      prev() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.displayUpToIndex();
          this.updateProgress();
        }
      }

      stop() {
        this.pause();
        this.currentIndex = this.messages.length - 1;
        this.displayUpToIndex();
        this.updateProgress();
        document
          .getElementById("time-machine-modal")
          .classList.remove("active");
      }

      branchFromCurrentPoint() {
        if (!this.sourceChat) return null;

        const branchChat = appState.createBranchChat(
          appState.currentUser.id,
          this.sourceChat,
          this.currentIndex
        );

        return branchChat;
      }

      displayUpToIndex() {
        const chatMessages = document.getElementById("chat-messages");
        chatMessages.innerHTML = "";

        for (let i = 0; i <= this.currentIndex; i++) {
          const msg = this.messages[i];
          ui.addMessageToUI(msg.role, msg.content, false);
        }

        ui.scrollToBottom();
      }

      updateProgress() {
        const progress = document.getElementById("time-machine-progress");
        progress.textContent = `${this.currentIndex + 1} / ${this.messages.length}`;
      }

      updatePlayButton() {
        const playButton = document.getElementById("time-machine-play");
        const icon = playButton.querySelector("i");
        if (this.isPlaying) {
          icon.className = "fas fa-pause";
        } else {
          icon.className = "fas fa-play";
        }
      }
    }

    // Initialize global instances
    const appState = new AppState();
    const soundManager = new SoundManager();
    const voiceManager = new VoiceManager();
    const timeMachine = new TimeMachine();

    // UI Controller
    class UIController {
      constructor() {
        this.loginPage = document.getElementById("login-page");
        this.appPage = document.getElementById("app");
        this.sidebar = document.getElementById("sidebar");
        this.sidebarOverlay = document.getElementById("sidebar-overlay");
        this.chatMessages = document.getElementById("chat-messages");
        this.userInput = document.getElementById("user-input");
        this.sendButton = document.getElementById("send-button");
        this.imagePreviewContainer = document.getElementById(
          "image-preview-container"
        );
        this.mentionDropdown = document.getElementById("mention-dropdown");
        this.pendingImage = null;
        this.mentionActive = false;
        this.mentionStartPos = -1;
        this.selectedMentionIndex = 0;
        this.currentEndpointId = null;
        this.editingEndpointId = null;

        this.initializeEventListeners();
        this.checkExistingSession();
      }

      initializeEventListeners() {
        // Login form
        document
          .getElementById("login-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            this.handleLogin();
          });

        // Header buttons
        document
          .getElementById("sidebar-toggle")
          .addEventListener("click", () => {
            this.toggleSidebar();
          });

        document
          .getElementById("archive-chat")
          .addEventListener("click", () => {
            this.archiveCurrentChat();
          });

        document
          .getElementById("theme-toggle")
          .addEventListener("click", () => {
            this.toggleTheme();
          });

        document.getElementById("logout").addEventListener("click", () => {
          this.logout();
        });

        // Clear chat button (floating)
        document
          .getElementById("clear-chat")
          .addEventListener("click", () => {
            this.clearCurrentChat();
          });

        // Voice toggle button
        document
          .getElementById("voice-toggle")
          .addEventListener("click", () => {
            if (!voiceManager.recognition) {
              this.showNotification(
                "Voice input is not supported in your browser. Please use Chrome or text input.",
                "warning"
              );
              return;
            }

            if (!appState.settings.voiceEnabled) {
              this.showNotification(
                "Voice features are disabled. Enable them in settings.",
                "info"
              );
              this.openSettings();
              return;
            }

            voiceManager.toggleListening((transcript) => {
              this.userInput.value = transcript;
              this.sendMessage();
            });
          });

        // Sidebar
        this.sidebarOverlay.addEventListener("click", () => {
          this.toggleSidebar();
        });

        // Sidebar tabs
        document.querySelectorAll(".sidebar-tab").forEach((tab) => {
          tab.addEventListener("click", (e) => {
            this.switchSidebarTab(e.target.dataset.tab);
          });
        });

        // Chat controls
        document.getElementById("new-chat").addEventListener("click", () => {
          this.createNewChat();
          this.toggleSidebar();
        });

        document
          .getElementById("send-button")
          .addEventListener("click", () => {
            this.sendMessage();
          });

        this.userInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Mention autocomplete
        this.userInput.addEventListener("input", (e) => {
          this.handleMentionInput(e);

          // Auto-resize textarea
          this.userInput.style.height = "auto";
          this.userInput.style.height =
            Math.min(this.userInput.scrollHeight, 120) + "px";
        });

        this.userInput.addEventListener("keydown", (e) => {
          if (this.mentionActive) {
            this.handleMentionNavigation(e);
          }
        });

        // Image upload
        document
          .getElementById("upload-image")
          .addEventListener("click", () => {
            document.getElementById("image-upload-input").click();
          });

        document
          .getElementById("image-upload-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.handleImageUpload(e.target.files[0]);
            }
          });

        // Paste event for images
        this.userInput.addEventListener("paste", (e) => {
          const items = e.clipboardData.items;
          for (let item of items) {
            if (item.type.indexOf("image") !== -1) {
              const file = item.getAsFile();
              this.handleImageUpload(file);
              e.preventDefault();
            }
          }
        });

        // Menu
        const menuToggle = document.getElementById("menu-toggle");
        const menuItems = document.getElementById("menu-items");

        menuToggle.addEventListener("click", () => {
          const isOpen = menuToggle.classList.toggle("active");
          menuItems.classList.toggle("open");
        });

        // Close menu when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !menuToggle.contains(e.target) &&
            !menuItems.contains(e.target)
          ) {
            menuToggle.classList.remove("active");
            menuItems.classList.remove("open");
          }
        });

        // Menu items
        document
          .getElementById("export-chat")
          .addEventListener("click", () => {
            this.exportCurrentChat();
            this.closeMenu();
          });

        document
          .getElementById("import-chat")
          .addEventListener("click", () => {
            document.getElementById("chat-import-input").click();
            this.closeMenu();
          });

        document
          .getElementById("export-all")
          .addEventListener("click", () => {
            this.exportAllData();
            this.closeMenu();
          });

        document
          .getElementById("import-all")
          .addEventListener("click", () => {
            document.getElementById("data-import-input").click();
            this.closeMenu();
          });

        document
          .getElementById("time-machine")
          .addEventListener("click", () => {
            this.openTimeMachine();
            this.closeMenu();
          });

        document.getElementById("settings").addEventListener("click", () => {
          this.openSettings();
          this.closeMenu();
        });

        // File inputs
        document
          .getElementById("chat-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importChat(e.target.files[0]);
            }
          });

        document
          .getElementById("data-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importAllData(e.target.files[0]);
            }
          });

        // Settings import/export
        document
          .getElementById("export-settings")
          .addEventListener("click", () => {
            this.exportSettings();
          });

        document
          .getElementById("import-settings")
          .addEventListener("click", () => {
            document.getElementById("settings-import-input").click();
          });

        document
          .getElementById("settings-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importSettings(e.target.files[0]);
            }
          });

        // Drag and drop
        this.initializeDragAndDrop();

        // Settings modal
        document
          .getElementById("settings-close")
          .addEventListener("click", () => {
            document
              .getElementById("settings-modal")
              .classList.remove("active");
          });

        document
          .getElementById("cancel-settings")
          .addEventListener("click", () => {
            document
              .getElementById("settings-modal")
              .classList.remove("active");
          });

        document
          .getElementById("save-all-settings")
          .addEventListener("click", () => {
            this.saveAllSettings();
          });

        document
          .getElementById("dark-mode-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("sound-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("voice-enabled-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("auto-speak-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("clear-all-data")
          .addEventListener("click", () => {
            if (
              confirm(
                "Are you sure you want to clear all data? This cannot be undone."
              )
            ) {
              appState.clearAllData();
              location.reload();
            }
          });

        // Endpoint management
        document
          .getElementById("add-endpoint")
          .addEventListener("click", () => {
            this.openEndpointModal();
          });

        document
          .getElementById("endpoint-modal-close")
          .addEventListener("click", () => {
            this.closeEndpointModal();
          });

        document
          .getElementById("cancel-endpoint")
          .addEventListener("click", () => {
            this.closeEndpointModal();
          });

        document
          .getElementById("save-endpoint")
          .addEventListener("click", () => {
            this.saveEndpoint();
          });

        // Time Machine modal
        document
          .getElementById("time-machine-close")
          .addEventListener("click", () => {
            timeMachine.stop();
          });

        document
          .getElementById("time-machine-start")
          .addEventListener("click", () => {
            const chat =
              appState.chats[appState.currentUser.id][appState.currentChatId];
            if (chat && chat.messages.length > 0) {
              timeMachine.init(chat.messages, chat);
              document
                .getElementById("time-machine-controls")
                .classList.remove("hidden");
              timeMachine.displayUpToIndex();
            }
          });

        document
          .getElementById("time-machine-prev")
          .addEventListener("click", () => {
            timeMachine.prev();
          });

        document
          .getElementById("time-machine-play")
          .addEventListener("click", () => {
            if (timeMachine.isPlaying) {
              timeMachine.pause();
            } else {
              timeMachine.play();
            }
          });

        document
          .getElementById("time-machine-next")
          .addEventListener("click", () => {
            timeMachine.next();
          });

        document
          .getElementById("time-machine-stop")
          .addEventListener("click", () => {
            timeMachine.stop();
          });

        document
          .getElementById("time-machine-branch")
          .addEventListener("click", () => {
            const branchChat = timeMachine.branchFromCurrentPoint();
            if (branchChat) {
              document
                .getElementById("time-machine-modal")
                .classList.remove("active");

              this.loadChat(branchChat.id);
              this.loadUserChats("active");

              this.showNotification(
                `Created branch from message ${timeMachine.currentIndex + 1}. You can now continue the conversation from this point.`,
                "success"
              );
            }
          });
      }

      handleMentionInput(e) {
        const value = this.userInput.value;
        const cursorPos = this.userInput.selectionStart;

        // Check for @ symbol
        const lastAtPos = value.lastIndexOf('@', cursorPos - 1);

        if (lastAtPos >= 0 && (lastAtPos === 0 || value[lastAtPos - 1] === ' ')) {
          const searchTerm = value.substring(lastAtPos + 1, cursorPos).toLowerCase();

          // Don't show dropdown if there's a space after @
          if (searchTerm.includes(' ')) {
            this.closeMentionDropdown();
            return;
          }

          this.mentionActive = true;
          this.mentionStartPos = lastAtPos;
          this.showMentionDropdown(searchTerm);
        } else {
          this.closeMentionDropdown();
        }
      }

      showMentionDropdown(searchTerm) {
        const endpoints = Object.values(appState.endpoints).filter(endpoint =>
          endpoint.name.toLowerCase().includes(searchTerm)
        );

        if (endpoints.length === 0) {
          this.closeMentionDropdown();
          return;
        }

        this.mentionDropdown.innerHTML = '';
        this.selectedMentionIndex = 0;

        endpoints.forEach((endpoint, index) => {
          const item = document.createElement('div');
          item.className = 'mention-item' + (index === 0 ? ' selected' : '');
          item.innerHTML = `
            <div class="mention-item-icon">${endpoint.name.charAt(0).toUpperCase()}</div>
            <div class="mention-item-info">
              <div class="mention-item-name">${endpoint.name}</div>
              <div class="mention-item-url">${endpoint.url}</div>
            </div>
          `;

          item.addEventListener('click', () => {
            this.selectMention(endpoint);
          });

          this.mentionDropdown.appendChild(item);
        });

        this.mentionDropdown.classList.add('active');
      }

      handleMentionNavigation(e) {
        const items = this.mentionDropdown.querySelectorAll('.mention-item');

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          this.selectedMentionIndex = Math.min(this.selectedMentionIndex + 1, items.length - 1);
          this.updateMentionSelection();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          this.selectedMentionIndex = Math.max(this.selectedMentionIndex - 1, 0);
          this.updateMentionSelection();
        } else if (e.key === 'Enter' || e.key === 'Tab') {
          e.preventDefault();
          const endpoints = Object.values(appState.endpoints);
          const visibleEndpoints = Array.from(items).map(item => {
            const name = item.querySelector('.mention-item-name').textContent;
            return endpoints.find(ep => ep.name === name);
          });

          if (visibleEndpoints[this.selectedMentionIndex]) {
            this.selectMention(visibleEndpoints[this.selectedMentionIndex]);
          }
        } else if (e.key === 'Escape') {
          this.closeMentionDropdown();
        }
      }

      updateMentionSelection() {
        const items = this.mentionDropdown.querySelectorAll('.mention-item');
        items.forEach((item, index) => {
          item.classList.toggle('selected', index === this.selectedMentionIndex);
        });
      }

      selectMention(endpoint) {
        const value = this.userInput.value;
        const beforeMention = value.substring(0, this.mentionStartPos);
        const afterMention = value.substring(this.userInput.selectionStart);

        this.userInput.value = `${beforeMention}@${endpoint.name} ${afterMention}`;
        this.currentEndpointId = endpoint.id;

        const newCursorPos = beforeMention.length + endpoint.name.length + 2;
        this.userInput.setSelectionRange(newCursorPos, newCursorPos);

        this.closeMentionDropdown();
        this.userInput.focus();
      }

      closeMentionDropdown() {
        this.mentionActive = false;
        this.mentionStartPos = -1;
        this.selectedMentionIndex = 0;
        this.mentionDropdown.classList.remove('active');
        this.mentionDropdown.innerHTML = '';
      }

      openEndpointModal(endpointId = null) {
        this.editingEndpointId = endpointId;
        const modal = document.getElementById('endpoint-modal');
        const title = document.getElementById('endpoint-modal-title');

        if (endpointId) {
          title.textContent = 'Edit Endpoint';
          const endpoint = appState.getEndpointById(endpointId);
          document.getElementById('endpoint-name').value = endpoint.name;
          document.getElementById('endpoint-url').value = endpoint.url;
          document.getElementById('endpoint-key').value = endpoint.key;
          document.getElementById('endpoint-guid').value = endpoint.guid;
        } else {
          title.textContent = 'Add Endpoint';
          document.getElementById('endpoint-name').value = '';
          document.getElementById('endpoint-url').value = '';
          document.getElementById('endpoint-key').value = '';
          document.getElementById('endpoint-guid').value = 'c0p110t0-aaaa-bbbb-cccc-123456789abc';
        }

        modal.classList.add('active');
      }

      closeEndpointModal() {
        document.getElementById('endpoint-modal').classList.remove('active');
        this.editingEndpointId = null;
      }

      saveEndpoint() {
        const name = document.getElementById('endpoint-name').value.trim();
        const url = document.getElementById('endpoint-url').value.trim();
        const key = document.getElementById('endpoint-key').value.trim();
        const guid = document.getElementById('endpoint-guid').value.trim() || 'c0p110t0-aaaa-bbbb-cccc-123456789abc';

        if (!name || !url) {
          this.showNotification('Please fill in name and URL', 'warning');
          return;
        }

        if (this.editingEndpointId) {
          appState.updateEndpoint(this.editingEndpointId, { name, url, key, guid });
        } else {
          appState.addEndpoint(name, url, key, guid);
        }

        this.loadEndpointList();
        this.closeEndpointModal();
        this.showNotification('Endpoint saved successfully!', 'success');
      }

      loadEndpointList() {
        const endpointList = document.getElementById('endpoint-list');
        endpointList.innerHTML = '';

        const endpoints = Object.values(appState.endpoints);

        if (endpoints.length === 0) {
          endpointList.innerHTML = '<p style="color: var(--gray-60); text-align: center; padding: 20px;">No endpoints configured</p>';
          return;
        }

        endpoints.forEach(endpoint => {
          const item = document.createElement('div');
          item.className = 'endpoint-item';
          item.innerHTML = `
            <div class="endpoint-item-icon">${endpoint.name.charAt(0).toUpperCase()}</div>
            <div class="endpoint-item-info">
              <div class="endpoint-item-name">${endpoint.name}</div>
              <div class="endpoint-item-url">${endpoint.url}</div>
            </div>
            <div class="endpoint-item-actions">
              <button class="endpoint-item-action ${endpoint.active ? 'active' : ''}" title="${endpoint.active ? 'Active' : 'Set as default'}">
                <i class="fas fa-check"></i>
              </button>
              <button class="endpoint-item-action" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="endpoint-item-action" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;

          const actions = item.querySelectorAll('.endpoint-item-action');

          // Set active
          actions[0].addEventListener('click', () => {
            appState.setActiveEndpoint(endpoint.id);
            this.loadEndpointList();
          });

          // Edit
          actions[1].addEventListener('click', () => {
            this.openEndpointModal(endpoint.id);
          });

          // Delete
          actions[2].addEventListener('click', () => {
            if (confirm(`Delete endpoint "${endpoint.name}"?`)) {
              appState.deleteEndpoint(endpoint.id);
              this.loadEndpointList();
            }
          });

          endpointList.appendChild(item);
        });
      }

      initializeDragAndDrop() {
        const dropZone = document.getElementById("drop-zone");
        let dragCounter = 0;

        document.addEventListener("dragenter", (e) => {
          e.preventDefault();
          dragCounter++;
          dropZone.classList.add("active");
        });

        document.addEventListener("dragleave", (e) => {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            dropZone.classList.remove("active");
          }
        });

        document.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        document.addEventListener("drop", (e) => {
          e.preventDefault();
          dragCounter = 0;
          dropZone.classList.remove("active");

          const files = Array.from(e.dataTransfer.files);
          files.forEach((file) => {
            if (file.type.startsWith("image/")) {
              this.handleImageUpload(file);
            } else if (file.type === "application/json") {
              this.handleJsonImport(file);
            }
          });
        });
      }

      checkExistingSession() {
        const lastUserId = localStorage.getItem("lastUserId");
        if (lastUserId && appState.users[lastUserId]) {
          appState.currentUser = appState.users[lastUserId];
          this.showApp();
        } else {
          this.showLogin();
        }
      }

      showLogin() {
        this.loginPage.classList.remove("hidden");
        this.appPage.classList.add("hidden");
        this.loadRecentUsers();
      }

      showApp() {
        this.loginPage.classList.add("hidden");
        this.appPage.classList.remove("hidden");

        document.getElementById("current-username").textContent =
          appState.currentUser.username;

        this.loadUserChats();
        this.applyTheme();
        this.applySettings();

        const activeChats = appState.getActiveChats(appState.currentUser.id);
        if (activeChats.length > 0) {
          this.loadChat(activeChats[0].id);
        } else {
          this.createNewChat();
        }
      }

      loadRecentUsers() {
        const recentUsersContainer = document.getElementById("recent-users");
        recentUsersContainer.innerHTML = "";

        const users = Object.values(appState.users)
          .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
          .slice(0, 5);

        users.forEach((user) => {
          const userElement = document.createElement("div");
          userElement.className = "user-item";
          userElement.innerHTML = `
            <div class="user-info">
              <div class="user-name">${user.username}</div>
              <div class="user-last-active">Last active: ${this.formatDate(
            user.lastActive
          )}</div>
            </div>
            <i class="fas fa-chevron-right"></i>
          `;
          userElement.addEventListener("click", () => {
            document.getElementById("username").value = user.username;
            this.handleLogin();
          });
          recentUsersContainer.appendChild(userElement);
        });
      }

      handleLogin() {
        const username = document.getElementById("username").value.trim();
        if (!username) return;

        let user = Object.values(appState.users).find(
          (u) => u.username === username
        );
        if (!user) {
          user = appState.createUser(username);
        }

        appState.currentUser = user;
        localStorage.setItem("lastUserId", user.id);

        this.showApp();
      }

      logout() {
        appState.currentUser = null;
        localStorage.removeItem("lastUserId");
        this.showLogin();
      }

      toggleSidebar() {
        this.sidebar.classList.toggle("open");
        this.sidebarOverlay.classList.toggle("active");
      }

      switchSidebarTab(tab) {
        document.querySelectorAll(".sidebar-tab").forEach((t) => {
          t.classList.toggle("active", t.dataset.tab === tab);
        });

        document
          .getElementById("chat-list-active")
          .classList.toggle("hidden", tab !== "active");
        document
          .getElementById("chat-list-archived")
          .classList.toggle("hidden", tab !== "archived");

        this.loadUserChats(tab);
      }

      loadUserChats(tab = "active") {
        const containerId =
          tab === "active" ? "chat-list-active" : "chat-list-archived";
        const chatList = document.getElementById(containerId);
        chatList.innerHTML = "";

        const chats =
          tab === "active"
            ? appState.getActiveChats(appState.currentUser.id)
            : appState.getArchivedChats(appState.currentUser.id);

        if (chats.length === 0) {
          chatList.innerHTML = `<div class="chat-list-empty">No ${tab} chats</div>`;
          return;
        }

        chats.forEach((chat) => {
          const chatElement = document.createElement("div");
          chatElement.className = "chat-item";
          if (chat.id === appState.currentChatId) {
            chatElement.classList.add("active");
          }

          const lastMessage = chat.messages[chat.messages.length - 1];
          const preview = lastMessage
            ? this.truncateText(lastMessage.content, 50)
            : "New conversation";

          chatElement.innerHTML = `
            <div class="chat-item-title">${chat.title}</div>
            <div class="chat-item-preview">${preview}</div>
            <div class="chat-item-date">${this.formatDate(
            chat.updatedAt
          )}</div>
            <div class="chat-item-actions">
              ${tab === "active"
              ? '<button class="chat-item-action" title="Archive"><i class="fas fa-archive"></i></button>'
              : '<button class="chat-item-action" title="Restore"><i class="fas fa-undo"></i></button>'
            }
              <button class="chat-item-action" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          `;

          chatElement.addEventListener("click", (e) => {
            if (!e.target.closest(".chat-item-action")) {
              this.loadChat(chat.id);
              this.toggleSidebar();
            }
          });

          const archiveBtn = chatElement.querySelector(
            ".chat-item-action:first-child"
          );
          archiveBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (tab === "active") {
              appState.archiveChat(appState.currentUser.id, chat.id);
              if (chat.id === appState.currentChatId) {
                this.createNewChat();
              }
            } else {
              appState.unarchiveChat(appState.currentUser.id, chat.id);
            }
            this.loadUserChats(tab);
          });

          const deleteBtn = chatElement.querySelector(
            ".chat-item-action:last-child"
          );
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (
              confirm(
                "Are you sure you want to permanently delete this chat?"
              )
            ) {
              appState.deleteChat(appState.currentUser.id, chat.id);
              if (chat.id === appState.currentChatId) {
                this.createNewChat();
              }
              this.loadUserChats(tab);
            }
          });

          chatList.appendChild(chatElement);
        });
      }

      createNewChat() {
        const chat = appState.createChat(appState.currentUser.id);
        appState.currentChatId = chat.id;
        this.currentEndpointId = null;
        this.loadUserChats("active");
        this.clearChatMessages();
      }

      loadChat(chatId) {
        const chat = appState.chats[appState.currentUser.id][chatId];
        if (!chat) return;

        appState.currentChatId = chatId;
        this.currentEndpointId = null;
        this.loadUserChats(chat.archived ? "archived" : "active");
        this.displayChatMessages(chat.messages);
      }

      clearCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) {
          this.createNewChat();
          return;
        }

        if (chat.archived) {
          appState.unarchiveChat(
            appState.currentUser.id,
            appState.currentChatId
          );
        }

        this.createNewChat();
      }

      archiveCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) return;

        if (
          confirm(
            "Archive this chat? You can restore it later from the archived tab."
          )
        ) {
          appState.archiveChat(
            appState.currentUser.id,
            appState.currentChatId
          );
          this.createNewChat();
        }
      }

      displayChatMessages(messages) {
        this.chatMessages.innerHTML = "";
        if (messages.length === 0) {
          this.showWelcomeState();
        } else {
          messages.forEach((message) => {
            this.addMessageToUI(
              message.role,
              message.content,
              false,
              message.voiceResponse,
              message.endpointName
            );
          });
          this.scrollToBottom();
        }
      }

      clearChatMessages() {
        this.chatMessages.innerHTML = "";
        this.showWelcomeState();
      }

      showWelcomeState() {
        const prompts = [
          {
            icon: "fa-envelope-open-text",
            label: "Email Triage",
            text: "I have 47 unread emails - summarize action items I missed, add them to my task list, and draft apology replies to anyone I left hanging."
          },
          {
            icon: "fa-brain",
            label: "Context Recovery",
            text: "Someone asked about the 'Henderson project' but I have no idea what they're talking about - search my emails, chats, and meetings and brief me."
          },
          {
            icon: "fa-heart",
            label: "Relationship Memory",
            text: "Remind me of personal details about my client Jessica before our call so I can build a real relationship instead of sounding like a robot."
          },
          {
            icon: "fa-layer-group",
            label: "Cross-System Synthesis",
            text: "Find the budget spreadsheet Sarah shared in Teams last month, pull the Q4 numbers, and draft an email comparing them to our projections."
          },
          {
            icon: "fa-balance-scale",
            label: "Work-Life Check",
            text: "Compare my calendar patterns from this quarter vs last and roast me (gently) about my work-life balance, then suggest time blocks to protect."
          },
          {
            icon: "fa-pen-fancy",
            label: "Write In My Voice",
            text: "Write the quarterly update email in my voice, but adjust the tone for each department head based on how they like to receive information."
          },
          {
            icon: "fa-users-cog",
            label: "Multi-Agent Analysis",
            text: "Analyze our top 20 customers by revenue, pull their support tickets and email sentiment, then draft executive briefings for each account manager."
          },
          {
            icon: "fa-calendar-check",
            label: "Meeting Optimizer",
            text: "Track how much time I spend in 'syncs' versus deep work, then auto-decline recurring meetings where I haven't spoken in 3+ sessions."
          },
          {
            icon: "fa-lightbulb",
            label: "Self-Awareness",
            text: "When I say I want to 'move fast,' compare that to how I've actually made decisions historically and tell me what I really mean."
          },
          {
            icon: "fa-magic",
            label: "Creative Voice",
            text: "Create a bedtime story for my daughter about a dragon who learns to code, then read it out loud in a soothing voice."
          }
        ];

        const welcomeHTML = `
          <div class="welcome-state">
            <div class="welcome-logo">
              <i class="fas fa-robot"></i>
            </div>
            <h1 class="welcome-title">What can I help you with?</h1>
            <p class="welcome-subtitle">I'm your AI assistant with persistent memory, multi-agent powers, and deep Microsoft 365 integration.</p>
            <div class="welcome-prompts-title">Try one of these</div>
            <div class="welcome-prompts">
              ${prompts.map((p, i) => `
                <div class="welcome-prompt" data-prompt-index="${i}">
                  <div class="welcome-prompt-icon">
                    <i class="fas ${p.icon}"></i>
                  </div>
                  <div class="welcome-prompt-content">
                    <div class="welcome-prompt-label">${p.label}</div>
                    <div class="welcome-prompt-text">${p.text}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;

        this.chatMessages.innerHTML = welcomeHTML;

        // Add click handlers for prompts
        this.chatMessages.querySelectorAll('.welcome-prompt').forEach((el) => {
          el.addEventListener('click', () => {
            const index = parseInt(el.dataset.promptIndex);
            this.userInput.value = prompts[index].text;
            this.userInput.focus();
            // Auto-resize textarea
            this.userInput.style.height = 'auto';
            this.userInput.style.height = Math.min(this.userInput.scrollHeight, 120) + 'px';
          });
        });
      }

      hideWelcomeState() {
        const welcomeState = this.chatMessages.querySelector('.welcome-state');
        if (welcomeState) {
          welcomeState.remove();
        }
      }

      createMessageElement(role, content, endpointName = null) {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `message-wrapper ${role}`;

        if (role === "system") {
          const systemMessage = document.createElement("div");
          systemMessage.className = "system-message";

          const agentMatch = content.match(/Agent: ([^\n]+)/);
          if (agentMatch) {
            const agentName = agentMatch[1];
            const uniqueId =
              "agent-output-" + Math.random().toString(36).substr(2, 9);

            const agentWrapper = document.createElement("div");
            agentWrapper.className = "agent-output-wrapper";
            agentWrapper.id = uniqueId;

            agentWrapper.innerHTML = `
              <div class="agent-output-header" onclick="ui.toggleAgentOutput('${uniqueId}')">
                <div class="agent-output-title">
                  <i class="fas fa-robot"></i>
                  <span>Agent: ${agentName}</span>
                </div>
                <button class="agent-output-toggle">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
              <div class="agent-output-content" id="${uniqueId}-content">
                <div class="agent-output-text">${content}</div>
              </div>
            `;

            messageWrapper.appendChild(agentWrapper);
          } else {
            systemMessage.textContent = content;
            messageWrapper.appendChild(systemMessage);
          }
        } else {
          const label = document.createElement("div");
          label.className = "message-label";
          label.innerHTML = role === "user"
            ? "You"
            : `${appState.currentUser.username}'s Assistant${endpointName ? `<span class="endpoint-badge"><i class="fas fa-server"></i>${endpointName}</span>` : ''}`;

          const messageContent = document.createElement("div");
          messageContent.className = "message-content";

          if (role === "user" && content.startsWith("data:image")) {
            messageContent.innerHTML = `<img src="${content}" alt="Uploaded image" style="max-width: 100%; border-radius: 8px;">`;
          } else {
            messageContent.innerHTML = this.formatMessage(content);
          }

          messageWrapper.appendChild(label);
          messageWrapper.appendChild(messageContent);
        }

        return messageWrapper;
      }

      toggleAgentOutput(id) {
        const content = document.getElementById(id + "-content");
        const header = document.querySelector(`#${id} .agent-output-header`);
        const toggleIcon = header.querySelector(".agent-output-toggle i");

        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          toggleIcon.className = "fas fa-chevron-down";
        } else {
          content.classList.add("expanded");
          toggleIcon.className = "fas fa-chevron-up";
        }
      }

      addMessageToUI(role, content, animate = true, voiceResponse = null, endpointName = null) {
        // Hide welcome state when adding messages
        this.hideWelcomeState();

        const messageWrapper = this.createMessageElement(role, content, endpointName);

        if (role === "assistant" && voiceResponse) {
          const voiceMessage = document.createElement("div");
          voiceMessage.className = "voice-message active";
          voiceMessage.innerHTML = `
            <i class="fas fa-volume-up"></i>
            <span>Voice: "${voiceResponse}"</span>
          `;
          messageWrapper.appendChild(voiceMessage);
        }

        this.chatMessages.appendChild(messageWrapper);

        if (role === "assistant" || role === "system") {
          messageWrapper.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightBlock(block);
          });

          // Add copy buttons to code blocks (Cycle 1 Feature)
          messageWrapper.querySelectorAll("pre").forEach((pre) => {
            const copyBtn = document.createElement("button");
            copyBtn.className = "code-copy-btn";
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.title = "Copy code";
            copyBtn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const code = pre.querySelector("code")?.textContent || pre.textContent;
              try {
                await navigator.clipboard.writeText(code);
                copyBtn.classList.add("copied");
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                  copyBtn.classList.remove("copied");
                  copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
              } catch (err) {
                console.error("Copy failed:", err);
              }
            });
            pre.appendChild(copyBtn);
          });
        }

        if (animate) {
          this.scrollToBottom();
        }
      }

      formatMessage(text) {
        let formattedText = text;

        // Handle @mentions
        formattedText = formattedText.replace(/@(\w+)/g, (match, name) => {
          return `<span class="mention-tag">@${name}</span>`;
        });

        formattedText = formattedText.replace(
          /```(\w+)?\n([\s\S]+?)```/g,
          (match, lang, code) => {
            const language = lang || "plaintext";
            const escapedCode = this.escapeHtml(code.trim());
            return `<pre><code class="${language}">${escapedCode}</code></pre>`;
          }
        );

        formattedText = formattedText.replace(/`([^`]+)`/g, (match, code) => {
          return `<code>${this.escapeHtml(code)}</code>`;
        });

        formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        formattedText = formattedText.replace(/\*([^*]+)\*/g, "<em>$1</em>");

        formattedText = formattedText.replace(
          /\[([^\]]+)\]\(([^)]+)\)/g,
          (match, linkText, url) => {
            return `<span class="link-wrapper"><a href="${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${linkText}</a></span>`;
          }
        );

        formattedText = formattedText.replace(
          /!\[([^\]]*)\]\(([^)]+)\)/g,
          (match, altText, url) => {
            const displayText = altText || "Image";
            const imageExtensions = ["jpg", "jpeg", "png", "gif", "svg", "webp", "bmp"];
            const urlLower = url.toLowerCase();
            const isImage = imageExtensions.some(
              (ext) =>
                urlLower.includes(`.${ext}`) ||
                urlLower.includes(`/${ext}?`) ||
                urlLower.includes("generated_images")
            );

            if (isImage) {
              return `
                <div style="margin: 10px 0;">
                  <div style="margin-bottom: 5px;">
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">
                      <i class="fas fa-external-link-alt" style="font-size: 12px;"></i> ${displayText}
                    </a>
                  </div>
                  <img src="${url}"
                       alt="${displayText}"
                       style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-small); cursor: pointer;"
                       onclick="window.open('${url.replace(/'/g, "\\'")}', '_blank')"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div style="display: none; padding: 20px; background: var(--gray-20); border-radius: 8px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 24px;"></i>
                    <p style="margin: 10px 0 5px 0; color: var(--gray-80);">Unable to load image</p>
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">
                      Click here to view image
                    </a>
                  </div>
                </div>
              `;
            } else {
              return `<span class="link-wrapper"><a href="${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${displayText}</a></span>`;
            }
          }
        );

        formattedText = formattedText.replace(
          /(https?:\/\/[^\s<]+)(?![^<]*>|[^<>]*<\/)/g,
          (match, url) => {
            const imageExtensions = ["jpg", "jpeg", "png", "gif", "svg", "webp", "bmp"];
            const urlLower = url.toLowerCase();
            const isImage = imageExtensions.some(
              (ext) =>
                urlLower.includes(`.${ext}`) ||
                urlLower.includes(`/${ext}?`) ||
                urlLower.includes("generated_images")
            );

            if (isImage) {
              return `
                <div style="margin: 10px 0;">
                  <div style="margin-bottom: 5px;">
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none; font-size: 13px; word-break: break-all;">
                      <i class="fas fa-external-link-alt" style="font-size: 12px;"></i> ${url}
                    </a>
                  </div>
                  <img src="${url}"
                       alt="Image"
                       style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-small); cursor: pointer;"
                       onclick="window.open('${url.replace(/'/g, "\\'")}', '_blank')"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div style="display: none; padding: 20px; background: var(--gray-20); border-radius: 8px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 24px;"></i>
                    <p style="margin: 10px 0 5px 0; color: var(--gray-80);">Unable to load image</p>
                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">
                      Click here to view image
                    </a>
                  </div>
                </div>
              `;
            } else {
              return `<span class="link-wrapper"><a href="${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${url}</a></span>`;
            }
          }
        );

        formattedText = formattedText.replace(/\n/g, "<br>");

        return formattedText;
      }

      escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async sendMessage() {
        const message = this.userInput.value.trim();
        if (!message && !this.pendingImage) return;

        // Check for @mentions in message
        const mentionRegex = /@(\w+)/g;
        let targetEndpoint = null;
        const mentions = [];
        let match;

        while ((match = mentionRegex.exec(message)) !== null) {
          mentions.push(match[1]);
        }

        // Find endpoint by mention
        if (mentions.length > 0) {
          const endpoints = Object.values(appState.endpoints);
          targetEndpoint = endpoints.find(ep =>
            mentions.some(mention => ep.name.toLowerCase() === mention.toLowerCase())
          );
        }

        // Use mentioned endpoint, or current endpoint, or active endpoint
        const endpoint = targetEndpoint ||
          (this.currentEndpointId ? appState.getEndpointById(this.currentEndpointId) : null) ||
          appState.getActiveEndpoint();

        if (!endpoint || !endpoint.url) {
          this.openSettings();
          this.showNotification(
            "Please configure at least one endpoint",
            "warning"
          );
          return;
        }

        this.sendButton.disabled = true;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        const userMessage = {
          role: "user",
          content: this.pendingImage || message,
          timestamp: new Date().toISOString(),
        };

        chat.messages.push(userMessage);
        this.addMessageToUI("user", userMessage.content);

        this.userInput.value = "";
        this.userInput.style.height = "auto";
        this.clearImagePreview();

        soundManager.playSendSound();

        this.showLoadingIndicator();

        try {
          const response = await fetch(endpoint.url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-functions-key": endpoint.key,
            },
            body: JSON.stringify({
              user_input: message || "Please analyze this image",
              conversation_history: chat.messages,
              user_guid: endpoint.guid,
            }),
          });

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error(
                `Invalid function key for ${endpoint.name}. Please check your settings.`
              );
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          this.hideLoadingIndicator();

          const assistantMessage = {
            role: "assistant",
            content:
              data.assistant_response ||
              data.text ||
              "Sorry, I received an empty response.",
            voiceResponse: data.voice_response || null,
            endpointName: endpoint.name,
            timestamp: new Date().toISOString(),
          };

          chat.messages.push(assistantMessage);
          this.addMessageToUI(
            "assistant",
            assistantMessage.content,
            true,
            assistantMessage.voiceResponse,
            assistantMessage.endpointName
          );

          soundManager.playReceiveSound();

          if (appState.settings.autoSpeak && assistantMessage.voiceResponse) {
            await voiceManager.speak(assistantMessage.voiceResponse);
          }

          if (data.agent_logs) {
            const systemMessage = {
              role: "system",
              content: data.agent_logs,
              timestamp: new Date().toISOString(),
            };
            chat.messages.push(systemMessage);
            this.addMessageToUI("system", systemMessage.content);
          }

          chat.updatedAt = new Date().toISOString();
          if (chat.messages.length === 2) {
            chat.title = this.generateChatTitle(message || "Image analysis");
          }

          appState.saveChats();
          this.loadUserChats("active");
        } catch (error) {
          console.error("Error:", error);
          this.hideLoadingIndicator();
          this.addMessageToUI("system", `Error: ${error.message}`);
          soundManager.playNotificationSound();
        } finally {
          this.sendButton.disabled = false;
          this.userInput.focus();
        }
      }

      showLoadingIndicator() {
        const existingLoading = document.getElementById("loading-indicator");
        if (existingLoading) {
          existingLoading.remove();
        }

        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading active";
        loadingDiv.id = "loading-indicator";
        loadingDiv.innerHTML = `
          <span></span>
          <span></span>
          <span></span>
        `;
        this.chatMessages.appendChild(loadingDiv);
        this.scrollToBottom();
      }

      hideLoadingIndicator() {
        const loadingIndicators = document.querySelectorAll(".loading");
        loadingIndicators.forEach((indicator) => {
          indicator.remove();
        });
      }

      handleImageUpload(file) {
        if (!file || !file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          this.pendingImage = e.target.result;
          this.showImagePreview(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      showImagePreview(imageSrc) {
        this.imagePreviewContainer.innerHTML = `
          <div class="image-preview">
            <img src="${imageSrc}" alt="Preview">
            <button class="image-preview-remove" onclick="ui.clearImagePreview()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        this.imagePreviewContainer.classList.add("active");
      }

      clearImagePreview() {
        this.pendingImage = null;
        this.imagePreviewContainer.innerHTML = "";
        this.imagePreviewContainer.classList.remove("active");
      }

      exportCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];

        const conversation = chat.messages.map((msg) => ({
          role: msg.role,
          content: msg.content,
        }));

        const endpoint = appState.getActiveEndpoint();

        const exportData = {
          conversation: conversation,
          guid: endpoint.guid,
          timestamp: new Date().toISOString(),
          appName: "_",
        };

        const filename = `conversation-${new Date()
          .toISOString()
          .replace(/:/g, "_")}.json`;
        this.downloadJson(exportData, filename);
      }

      exportAllData() {
        const exportData = appState.exportAllData();
        const filename = `rappid-full-backup-${new Date().toISOString().replace(/:/g, "-")}.json`;
        this.downloadJson(exportData, filename);
        this.showNotification("Full backup exported!", "success");
      }

      exportSettings() {
        const settingsData = appState.exportSettings();
        const endpointCount = Object.keys(settingsData.endpoints || {}).length;
        const activeEndpoint = Object.values(settingsData.endpoints || {}).find(e => e.active);
        const filename = `rappid-settings-${new Date().toISOString().replace(/:/g, "-")}.json`;
        this.downloadJson(settingsData, filename);
        this.showNotification(
          `RAPPID settings exported! ${endpointCount} endpoints${activeEndpoint ? ` (Active: ${activeEndpoint.name})` : ''}`,
          "success"
        );
      }

      importSettings(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const settingsData = JSON.parse(e.target.result);

            // Validate RAPPID or settings format
            const isRappid = settingsData.rappid === true || settingsData.backupType === "RAPPID Settings Backup";
            const isValidSettings = settingsData.version && (settingsData.endpoints || settingsData.azureTTSKey);

            if (!isRappid && !isValidSettings) {
              throw new Error("Invalid settings file format. Expected RAPPID backup or settings export.");
            }

            // Count endpoints before import
            const existingEndpoints = Object.keys(appState.endpoints).length;
            const importingEndpoints = Object.keys(settingsData.endpoints || {}).length;

            appState.importSettings(settingsData);

            this.applySettings();

            // Apply TTS settings to voice manager
            if (settingsData.azureTTSKey) {
              voiceManager.setAzureKey(settingsData.azureTTSKey);
            }
            if (settingsData.azureRegion) {
              voiceManager.azureRegion = settingsData.azureRegion;
            }
            if (settingsData.ttsVoiceName) {
              voiceManager.setVoiceName(settingsData.ttsVoiceName);
            }

            // Count endpoints after import
            const finalEndpoints = Object.keys(appState.endpoints).length;
            const newEndpoints = finalEndpoints - existingEndpoints;
            const activeEndpoint = appState.getActiveEndpoint();

            // Show detailed notification
            let message = isRappid ? "RAPPID settings imported! " : "Settings imported! ";
            message += `${finalEndpoints} endpoints`;
            if (newEndpoints > 0) message += ` (+${newEndpoints} new)`;
            if (activeEndpoint) message += `. Active: ${activeEndpoint.name}`;

            this.showNotification(message, "success");

            document.getElementById("settings-modal").classList.remove("active");

            this.openSettings();
          } catch (error) {
            this.showNotification(
              "Error importing settings: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      downloadJson(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      importChat(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            if (data.conversation && Array.isArray(data.conversation)) {
              const newChat = appState.createChat(appState.currentUser.id,
                "Imported Chat"
              );

              newChat.messages = data.conversation.map((msg) => ({
                role: msg.role,
                content: msg.content,
                timestamp: new Date().toISOString(),
              }));

              newChat.updatedAt = data.timestamp || new Date().toISOString();

              if (newChat.messages.length > 0) {
                const firstUserMessage = newChat.messages.find(
                  (m) => m.role === "user"
                );
                if (firstUserMessage) {
                  newChat.title = this.generateChatTitle(
                    firstUserMessage.content
                  );
                }
              }

              appState.saveChats();
              this.loadChat(newChat.id);
              this.loadUserChats("active");
              this.showNotification("Chat imported successfully!", "success");
            } else if (data.chat && data.chat.messages) {
              const newChat = appState.createChat(
                appState.currentUser.id,
                data.chat.title || "Imported Chat"
              );
              newChat.messages = data.chat.messages;
              newChat.updatedAt = new Date().toISOString();

              appState.saveChats();
              this.loadChat(newChat.id);
              this.loadUserChats("active");
              this.showNotification("Chat imported successfully!", "success");
            } else {
              throw new Error("Invalid chat format");
            }
          } catch (error) {
            this.showNotification(
              "Error importing chat: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      importAllData(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Check for RAPPID format or standard backup format
            const isRappid = data.rappid === true || data.backupType === "RAPPID Settings Backup";
            const isValidBackup = data.version && (data.users || data.chats || data.endpoints);

            if (!isRappid && !isValidBackup) {
              throw new Error("Invalid backup format. Expected RAPPID or app backup.");
            }

            // Build summary of what will be imported
            const summary = [];
            if (data.users) summary.push(`${Object.keys(data.users).length} users`);
            if (data.chats) {
              const chatCount = Object.values(data.chats).reduce((sum, uc) =>
                sum + Object.keys(uc || {}).length, 0);
              summary.push(`${chatCount} chats`);
            }
            if (data.endpoints) summary.push(`${Object.keys(data.endpoints).length} endpoints`);
            if (data.settings) summary.push("settings");
            if (data.azureTTSKey) summary.push("TTS config");

            const confirmMsg = isRappid
              ? `Import RAPPID backup? This will merge: ${summary.join(", ")}`
              : `Import backup? This will merge: ${summary.join(", ")}`;

            if (confirm(confirmMsg)) {
              // Store current user info
              const currentUserId = appState.currentUser?.id;

              appState.importAllData(data);

              // Apply TTS settings if present
              if (data.azureTTSKey) {
                voiceManager.setAzureKey(data.azureTTSKey);
              }
              if (data.azureRegion) {
                voiceManager.azureRegion = data.azureRegion;
              }
              if (data.ttsVoiceName) {
                voiceManager.setVoiceName(data.ttsVoiceName);
              }

              // Count what was imported
              const endpointCount = Object.keys(appState.endpoints).length;
              const userCount = Object.keys(appState.users).length;
              const activeEndpoint = appState.getActiveEndpoint();

              let successMsg = isRappid ? "RAPPID backup merged! " : "Backup merged! ";
              successMsg += `${endpointCount} endpoints, ${userCount} users`;
              if (activeEndpoint) successMsg += `. Active: ${activeEndpoint.name}`;

              this.showNotification(successMsg, "success");

              // Only logout if user data was imported
              if (data.users) {
                this.logout();
              } else {
                // Just refresh settings
                this.applySettings();
              }
            }
          } catch (error) {
            this.showNotification(
              "Error importing data: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      handleJsonImport(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Check for RAPPID format first
            const isRappid = data.rappid === true || data.backupType === "RAPPID Settings Backup";

            if (data.conversation || (data.chat && data.user)) {
              // Chat export format
              this.importChat(file);
            } else if (isRappid && !data.users && !data.chats) {
              // RAPPID settings-only backup (no users/chats)
              this.importSettings(file);
            } else if (data.users || data.chats || (isRappid && (data.users || data.chats))) {
              // Full backup format (RAPPID or standard)
              this.importAllData(file);
            } else if (data.endpoints) {
              // Settings/endpoints only
              this.importSettings(file);
            } else {
              this.showNotification("Unknown file format", "error");
            }
          } catch (error) {
            this.showNotification(
              "Error reading file: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      generateChatTitle(firstMessage) {
        const cleanMessage = firstMessage
          .replace(/[^\w\s]/g, "")
          .toLowerCase();
        const words = cleanMessage.split(" ").filter((w) => w.length > 3);

        if (words.length > 3) {
          return words.slice(0, 3).join(" ");
        } else if (firstMessage.length > 30) {
          return firstMessage.substring(0, 30) + "...";
        } else {
          return firstMessage;
        }
      }

      toggleTheme() {
        const isDark = document.body.classList.toggle("dark");
        appState.settings.theme = isDark ? "dark" : "light";
        appState.saveSettings();

        const themeIcon = document.querySelector("#theme-toggle i");
        themeIcon.className = isDark ? "fas fa-sun" : "fas fa-moon";

        const darkModeToggle = document.getElementById("dark-mode-toggle");
        if (darkModeToggle) {
          darkModeToggle.classList.toggle("active", isDark);
        }
      }

      applyTheme() {
        if (appState.settings.theme === "dark") {
          document.body.classList.add("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-sun";
        }
      }

      saveAllSettings() {
        const isDarkMode = document
          .getElementById("dark-mode-toggle")
          .classList.contains("active");
        appState.settings.theme = isDarkMode ? "dark" : "light";

        if (isDarkMode && !document.body.classList.contains("dark")) {
          document.body.classList.add("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-sun";
        } else if (!isDarkMode && document.body.classList.contains("dark")) {
          document.body.classList.remove("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-moon";
        }

        appState.settings.soundEnabled = document
          .getElementById("sound-toggle")
          .classList.contains("active");
        soundManager.setEnabled(appState.settings.soundEnabled);

        appState.settings.voiceEnabled = document
          .getElementById("voice-enabled-toggle")
          .classList.contains("active");
        appState.settings.autoSpeak = document
          .getElementById("auto-speak-toggle")
          .classList.contains("active");

        voiceManager.setEnabled(appState.settings.voiceEnabled);
        voiceManager.setAutoSpeak(appState.settings.autoSpeak);

        const azureTTSKey = document
          .getElementById("azure-tts-key")
          .value.trim();
        appState.settings.azureTTSKey = azureTTSKey;
        voiceManager.setAzureKey(azureTTSKey);

        const ttsVoice = document.getElementById("tts-voice-select").value;
        appState.settings.ttsVoiceName = ttsVoice;
        voiceManager.setVoiceName(ttsVoice);

        appState.saveSettings();

        this.showNotification("Settings saved successfully!", "success");
        document.getElementById("settings-modal").classList.remove("active");
      }

      applySettings() {
        this.applyTheme();

        soundManager.setEnabled(appState.settings.soundEnabled);

        voiceManager.setEnabled(appState.settings.voiceEnabled);
        voiceManager.setAutoSpeak(appState.settings.autoSpeak);
        voiceManager.setAzureKey(appState.settings.azureTTSKey);
        voiceManager.setVoiceName(appState.settings.ttsVoiceName);

        const darkModeToggle = document.getElementById("dark-mode-toggle");
        if (darkModeToggle) {
          darkModeToggle.classList.toggle(
            "active",
            appState.settings.theme === "dark"
          );
        }

        const soundToggle = document.getElementById("sound-toggle");
        if (soundToggle) {
          soundToggle.classList.toggle(
            "active",
            appState.settings.soundEnabled
          );
        }

        const voiceEnabledToggle = document.getElementById(
          "voice-enabled-toggle"
        );
        if (voiceEnabledToggle) {
          voiceEnabledToggle.classList.toggle(
            "active",
            appState.settings.voiceEnabled
          );
        }

        const autoSpeakToggle = document.getElementById("auto-speak-toggle");
        if (autoSpeakToggle) {
          autoSpeakToggle.classList.toggle(
            "active",
            appState.settings.autoSpeak
          );
        }

        const azureTTSKeyInput = document.getElementById("azure-tts-key");
        if (azureTTSKeyInput && appState.settings.azureTTSKey) {
          azureTTSKeyInput.value = appState.settings.azureTTSKey;
        }

        const ttsVoiceSelect = document.getElementById("tts-voice-select");
        if (ttsVoiceSelect) {
          ttsVoiceSelect.value = appState.settings.ttsVoiceName;
        }

        this.loadEndpointList();
      }

      openSettings() {
        this.applySettings();
        document.getElementById("settings-modal").classList.add("active");
      }

      openTimeMachine() {
        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) {
          this.showNotification(
            "No messages to replay in the current chat.",
            "info"
          );
          return;
        }

        document.getElementById("time-machine-modal").classList.add("active");
        document
          .getElementById("time-machine-controls")
          .classList.add("hidden");
      }

      closeMenu() {
        document.getElementById("menu-toggle").classList.remove("active");
        document.getElementById("menu-items").classList.remove("open");
      }

      scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }

      truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + "...";
      }

      formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "Just now";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

        return date.toLocaleDateString();
      }

      showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === "success"
            ? "var(--success)"
            : type === "error"
              ? "var(--error)"
              : type === "warning"
                ? "var(--warning)"
                : "var(--info)"
          };
          color: white;
          padding: 16px 24px;
          border-radius: var(--radius);
          box-shadow: var(--shadow-large);
          z-index: 2000;
          animation: slideUp 0.3s ease-out;
          max-width: 320px;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "fadeOut 0.3s ease-out";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
    }

    // ========================================
    // PROMPT LIBRARY - Power Prompts System
    // ========================================
    class PromptLibrary {
      constructor() {
        this.modal = document.getElementById('prompt-library-modal');
        this.content = document.getElementById('prompt-library-content');
        this.currentFilter = 'all';

        this.prompts = [
          {
            id: 'broken-promise',
            title: 'The Broken Promise Detector',
            icon: 'fa-handshake-slash',
            category: 'email',
            gradient: { start: '#ef4444', end: '#dc2626' },
            tags: ['Email Analysis', 'Pattern Matching', 'Relationship Intelligence'],
            prompt: "Scan my Outlook for every 'I'll get back to you' and 'Let me follow up' I sent in the last 90 days, cross-reference with my Sent folder to find the ones I never followed through on, rank them by how important the recipient is, and draft personalized 'sorry I dropped the ball' messages for each.",
            uiTemplate: 'email-list'
          },
          {
            id: 'political-mapper',
            title: 'The Political Reality Mapper',
            icon: 'fa-sitemap',
            category: 'relationships',
            gradient: { start: '#8b5cf6', end: '#7c3aed' },
            tags: ['Social Graph', 'Organizational Intelligence', 'Power Dynamics'],
            prompt: "Analyze my email CC patterns, meeting invite hierarchies, and who responds to whom first to map the ACTUAL political power structure in my organization - not the org chart, the real one. Show me who really has influence and where I stand.",
            uiTemplate: 'relationship-graph'
          },
          {
            id: 'contradiction-finder',
            title: 'The Contradiction Finder',
            icon: 'fa-exclamation-triangle',
            category: 'analytics',
            gradient: { start: '#f59e0b', end: '#d97706' },
            tags: ['Cross-Document Analysis', 'Risk Detection', 'Semantic Comparison'],
            prompt: "Search my SharePoint documents and emails for times I told different stakeholders different things about the same project - conflicting timelines, budgets, or priorities. I need to find these landmines before someone else does.",
            uiTemplate: 'comparison'
          },
          {
            id: 'relationship-decay',
            title: 'The Relationship Decay Alert',
            icon: 'fa-heart-crack',
            category: 'relationships',
            gradient: { start: '#ec4899', end: '#db2777' },
            tags: ['Sentiment Analysis', 'Longitudinal Tracking', 'Relationship Health'],
            prompt: "Create a relationship health dashboard for my top 20 contacts - based on email sentiment trends, response time changes, and meeting frequency drops. Rate each as thriving, cooling, or at-risk, and tell me specifically what happened with the ones that are dying.",
            uiTemplate: 'relationship-graph'
          },
          {
            id: 'crisis-predictor',
            title: 'The Future Crisis Predictor',
            icon: 'fa-crystal-ball',
            category: 'analytics',
            gradient: { start: '#06b6d4', end: '#0891b2' },
            tags: ['Predictive Analytics', 'Pattern Recognition', 'Risk Assessment'],
            prompt: "Based on my current project trajectories, team response patterns, upcoming deadlines, and historical 'how things went wrong before' data - predict which initiative will blow up in the next 30 days and tell me exactly what I'd need to do TODAY to prevent it.",
            uiTemplate: 'dashboard'
          },
          {
            id: 'meeting-autopsy',
            title: 'The Meeting Autopsy Report',
            icon: 'fa-skull',
            category: 'calendar',
            gradient: { start: '#64748b', end: '#475569' },
            tags: ['Calendar Analysis', 'Productivity Intelligence', 'Time Audit'],
            prompt: "Analyze every meeting I attended last quarter. Which ones actually produced decisions? Which were pure performance theater? Which should have been emails? Give me the brutal truth with specific examples - I want to see how much of my life I'm wasting.",
            uiTemplate: 'timeline'
          },
          {
            id: 'ghost-machine',
            title: 'The Ghost In The Machine',
            icon: 'fa-ghost',
            category: 'self',
            gradient: { start: '#a855f7', end: '#9333ea' },
            tags: ['Writing Analysis', 'Personal Coaching', 'Communication Style'],
            prompt: "You've read every email I've ever written. Show me my verbal tics, weak phrases, and unconscious patterns. Then take my 5 worst recent emails and rewrite them as the communicator I wish I was - same message, but actually effective.",
            uiTemplate: 'comparison'
          },
          {
            id: 'calendar-reality',
            title: 'The Calendar vs. Reality Audit',
            icon: 'fa-masks-theater',
            category: 'self',
            gradient: { start: '#14b8a6', end: '#0d9488' },
            tags: ['Intent vs Action', 'Self-Awareness', 'Behavioral Patterns'],
            prompt: "Compare what I SAID my priorities were in planning emails versus where my calendar time actually went. Show me the gap between who I claim to be and who my schedule says I am. I need to see how I'm lying to myself.",
            uiTemplate: 'comparison'
          },
          {
            id: 'burnout-warning',
            title: 'The Burnout Early Warning System',
            icon: 'fa-fire-flame-curved',
            category: 'analytics',
            gradient: { start: '#f97316', end: '#ea580c' },
            tags: ['Team Wellness', 'Predictive HR', 'Proactive Management'],
            prompt: "Monitor my team's digital body language across Teams and Outlook - late night messages, response time changes, sentiment shifts, calendar overload. Build me a dashboard that predicts who's heading toward burnout before they even know it themselves.",
            uiTemplate: 'dashboard'
          },
          {
            id: 'career-narrative',
            title: 'The Career Narrative Generator',
            icon: 'fa-trophy',
            category: 'self',
            gradient: { start: '#eab308', end: '#ca8a04' },
            tags: ['Narrative Synthesis', 'Achievement Extraction', 'Self-Advocacy'],
            prompt: "Turn my entire year of work into a compelling story for my performance review - every project, win, challenge, and growth moment synthesized from my emails, documents, and calendar. Make me sound like the hero I actually was, with real evidence to back every claim.",
            uiTemplate: 'narrative'
          }
        ];

        this.init();
      }

      init() {
        // Open button (FAB in float-buttons)
        document.getElementById('prompt-library-btn-fab').addEventListener('click', () => {
          this.open();
        });

        // Close button
        document.getElementById('prompt-library-close').addEventListener('click', () => {
          this.close();
        });

        // Close on backdrop click
        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) {
            this.close();
          }
        });

        // Filter buttons
        document.querySelectorAll('.prompt-filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.setFilter(e.target.dataset.filter);
          });
        });

        // Render initial prompts
        this.render();
      }

      open() {
        this.modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      close() {
        this.modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      setFilter(filter) {
        this.currentFilter = filter;

        // Update active button
        document.querySelectorAll('.prompt-filter-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === filter);
        });

        this.render();
      }

      getFilteredPrompts() {
        if (this.currentFilter === 'all') {
          return this.prompts;
        }
        return this.prompts.filter(p => p.category === this.currentFilter);
      }

      render() {
        const prompts = this.getFilteredPrompts();

        this.content.innerHTML = prompts.map(p => `
          <div class="prompt-card" data-prompt-id="${p.id}" style="--card-gradient-start: ${p.gradient.start}; --card-gradient-end: ${p.gradient.end};">
            <div class="prompt-card-header">
              <div class="prompt-card-icon">
                <i class="fas ${p.icon}"></i>
              </div>
              <div>
                <div class="prompt-card-title">${p.title}</div>
                <div class="prompt-card-category">${this.getCategoryLabel(p.category)}</div>
              </div>
            </div>
            <div class="prompt-card-text">${p.prompt}</div>
            <div class="prompt-card-tags">
              ${p.tags.map(tag => `<span class="prompt-tag">${tag}</span>`).join('')}
            </div>
            <div class="prompt-card-action">
              <i class="fas fa-arrow-right"></i>
            </div>
          </div>
        `).join('');

        // Add click handlers
        this.content.querySelectorAll('.prompt-card').forEach(card => {
          card.addEventListener('click', () => {
            const promptId = card.dataset.promptId;
            this.selectPrompt(promptId);
          });
        });
      }

      getCategoryLabel(category) {
        const labels = {
          email: 'Email Intelligence',
          relationships: 'Relationship Analysis',
          calendar: 'Calendar & Time',
          analytics: 'Predictive Analytics',
          self: 'Self-Awareness'
        };
        return labels[category] || category;
      }

      selectPrompt(promptId) {
        const prompt = this.prompts.find(p => p.id === promptId);
        if (!prompt) return;

        // Close the modal
        this.close();

        // Set the prompt in the input field
        const userInput = document.getElementById('user-input');
        userInput.value = prompt.prompt;
        userInput.focus();

        // Auto-resize textarea
        userInput.style.height = 'auto';
        userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';

        // Store the selected prompt for generative UI
        window.selectedPromptTemplate = prompt.uiTemplate;
        window.selectedPromptData = prompt;

        // Show notification
        ui.showNotification(`Loaded: ${prompt.title}`, 'success');
      }
    }

    // ========================================
    // GENERATIVE UI - Dynamic Response Templates
    // ========================================
    class GenerativeUI {
      constructor() {
        this.templates = {
          'email-list': this.renderEmailList,
          'relationship-graph': this.renderRelationshipGraph,
          'dashboard': this.renderDashboard,
          'timeline': this.renderTimeline,
          'narrative': this.renderNarrative,
          'comparison': this.renderComparison
        };
      }

      // Generate sample data based on template type
      generateSampleData(template) {
        switch(template) {
          case 'email-list':
            return {
              title: 'Unfollowed Promises Detected',
              items: [
                { initials: 'JD', name: 'John Davis', subject: 'Re: Q4 Budget Review', preview: "You said 'I'll send the updated figures by EOD'", priority: 'high', daysAgo: 12 },
                { initials: 'SM', name: 'Sarah Miller', subject: 'Project Timeline', preview: "You promised to 'circle back with the team'", priority: 'high', daysAgo: 8 },
                { initials: 'RK', name: 'Robert Kim', subject: 'Partnership Discussion', preview: "You mentioned 'Let me follow up next week'", priority: 'medium', daysAgo: 23 },
                { initials: 'AL', name: 'Amy Liu', subject: 'Design Feedback', preview: "You said 'I'll review and get back to you'", priority: 'medium', daysAgo: 15 },
                { initials: 'TC', name: 'Tom Chen', subject: 'Vendor Contracts', preview: "You promised to 'send over the comparison'", priority: 'low', daysAgo: 31 }
              ]
            };

          case 'relationship-graph':
            return {
              title: 'Relationship Health Dashboard',
              contacts: [
                { initials: 'EM', name: 'Emily Martinez', role: 'VP of Sales', status: 'thriving', trend: '+15% engagement' },
                { initials: 'JW', name: 'James Wilson', role: 'Product Lead', status: 'thriving', trend: 'Strong collaboration' },
                { initials: 'LT', name: 'Lisa Thompson', role: 'CFO', status: 'cooling', trend: '-30% response rate' },
                { initials: 'MR', name: 'Michael Ross', role: 'Engineering Dir', status: 'cooling', trend: 'Fewer meetings' },
                { initials: 'NK', name: 'Nina Kumar', role: 'HR Director', status: 'at-risk', trend: 'No contact 45 days' },
                { initials: 'DL', name: 'David Lee', role: 'Marketing VP', status: 'at-risk', trend: 'Declined 3 invites' }
              ]
            };

          case 'dashboard':
            return {
              cards: [
                { label: 'At-Risk Projects', value: '3', trend: 'up', trendText: '+2 from last month', color: '#ef4444' },
                { label: 'Predicted Issues', value: '7', trend: 'up', trendText: 'Next 30 days', color: '#f59e0b' },
                { label: 'Team Burnout Risk', value: '23%', trend: 'down', trendText: '-5% from last week', color: '#10b981' },
                { label: 'Meetings Needing Action', value: '12', trend: 'up', trendText: 'No follow-up yet', color: '#8b5cf6' }
              ]
            };

          case 'timeline':
            return {
              title: 'Meeting Analysis Timeline',
              items: [
                { icon: 'fa-check-circle', title: 'Q4 Planning Session', desc: 'Produced 5 actionable decisions', time: '2 weeks ago', status: 'productive' },
                { icon: 'fa-theater-masks', title: 'Weekly Status Sync', desc: 'No decisions - could be async update', time: '1 week ago', status: 'theater' },
                { icon: 'fa-envelope', title: 'Budget Review Call', desc: 'All info was already in the email thread', time: '5 days ago', status: 'email' },
                { icon: 'fa-check-circle', title: 'Product Roadmap Review', desc: 'Key prioritization decisions made', time: '3 days ago', status: 'productive' },
                { icon: 'fa-theater-masks', title: 'Cross-Team Alignment', desc: 'Repeated previous meeting content', time: 'Yesterday', status: 'theater' }
              ]
            };

          case 'narrative':
            return {
              text: "This year, you emerged as the quiet force behind three major initiatives that shaped the company's direction. When the Anderson account threatened to collapse in March, you orchestrated a recovery that not only saved the relationship but expanded it by 40%. Your documentation overhaul, initially met with skepticism, became the template adopted company-wide. Perhaps most notably, you mentored two junior team members who are now leading their own projectsa legacy that speaks louder than any metric.",
              author: { initials: 'AI', name: 'Your AI Advocate', role: 'Based on 847 emails, 156 documents, and 312 meetings' }
            };

          case 'comparison':
            return {
              leftTitle: 'What You Said',
              rightTitle: 'What You Did',
              leftItems: [
                '"Strategic planning is my top priority"',
                '"I need more focus time for deep work"',
                '"Team development is crucial this quarter"',
                '"I\'ll reduce meeting load by 20%"'
              ],
              rightItems: [
                '4 hours/week on strategy (8% of time)',
                '2.3 hours average focus blocks',
                '1 skip-level per month (down from 4)',
                'Meeting time increased 12%'
              ]
            };

          default:
            return null;
        }
      }

      render(template, customData = null) {
        const data = customData || this.generateSampleData(template);
        const renderFn = this.templates[template];

        if (!renderFn || !data) {
          return '';
        }

        return `<div class="gen-ui-container">${renderFn.call(this, data)}</div>`;
      }

      renderEmailList(data) {
        return `
          <div class="gen-ui-email-list">
            <div class="gen-ui-email-header">
              <i class="fas fa-envelope-open-text"></i>
              ${data.title}
            </div>
            ${data.items.map(item => `
              <div class="gen-ui-email-item">
                <div class="gen-ui-email-avatar">${item.initials}</div>
                <div class="gen-ui-email-content">
                  <div class="gen-ui-email-subject">${item.name} - ${item.subject}</div>
                  <div class="gen-ui-email-preview">${item.preview} (${item.daysAgo} days ago)</div>
                </div>
                <span class="gen-ui-email-priority ${item.priority}">${item.priority}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      renderRelationshipGraph(data) {
        return `
          <div class="gen-ui-relationship-graph">
            <div class="gen-ui-graph-header">
              <i class="fas fa-project-diagram"></i>
              ${data.title}
            </div>
            <div class="gen-ui-relationship-grid">
              ${data.contacts.map(contact => `
                <div class="gen-ui-relationship-node ${contact.status}">
                  <div class="gen-ui-node-avatar">${contact.initials}</div>
                  <div class="gen-ui-node-name">${contact.name}</div>
                  <div class="gen-ui-node-role">${contact.role}</div>
                  <span class="gen-ui-node-status ${contact.status}">${contact.status}</span>
                  <div style="font-size: 11px; color: var(--gray-60); margin-top: 8px;">${contact.trend}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      renderDashboard(data) {
        return `
          <div class="gen-ui-dashboard">
            ${data.cards.map(card => `
              <div class="gen-ui-dashboard-card" style="border-left-color: ${card.color}">
                <div class="gen-ui-dashboard-label">${card.label}</div>
                <div class="gen-ui-dashboard-value">${card.value}</div>
                <div class="gen-ui-dashboard-trend ${card.trend}">
                  <i class="fas fa-arrow-${card.trend}"></i>
                  ${card.trendText}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      renderTimeline(data) {
        return `
          <div class="gen-ui-timeline">
            <div class="gen-ui-timeline-header">
              <i class="fas fa-clock"></i>
              ${data.title}
            </div>
            ${data.items.map(item => `
              <div class="gen-ui-timeline-item">
                <div class="gen-ui-timeline-dot" style="background: ${item.status === 'productive' ? '#10b981' : item.status === 'theater' ? '#f59e0b' : '#64748b'}">
                  <i class="fas ${item.icon}"></i>
                </div>
                <div class="gen-ui-timeline-content">
                  <div class="gen-ui-timeline-title">${item.title}</div>
                  <div class="gen-ui-timeline-desc">${item.desc}</div>
                  <div class="gen-ui-timeline-time">${item.time}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      renderNarrative(data) {
        return `
          <div class="gen-ui-narrative">
            <div class="gen-ui-narrative-text">${data.text}</div>
            <div class="gen-ui-narrative-author">
              <div class="gen-ui-narrative-avatar"><i class="fas fa-robot"></i></div>
              <div>
                <div class="gen-ui-narrative-name">${data.author.name}</div>
                <div class="gen-ui-narrative-role">${data.author.role}</div>
              </div>
            </div>
          </div>
        `;
      }

      renderComparison(data) {
        return `
          <div class="gen-ui-comparison">
            <div class="gen-ui-comparison-side left">
              <div class="gen-ui-comparison-title">
                <i class="fas fa-comment" style="color: #ef4444"></i>
                ${data.leftTitle}
              </div>
              ${data.leftItems.map(item => `<div class="gen-ui-comparison-item">${item}</div>`).join('')}
            </div>
            <div class="gen-ui-comparison-vs">VS</div>
            <div class="gen-ui-comparison-side right">
              <div class="gen-ui-comparison-title">
                <i class="fas fa-chart-line" style="color: #10b981"></i>
                ${data.rightTitle}
              </div>
              ${data.rightItems.map(item => `<div class="gen-ui-comparison-item">${item}</div>`).join('')}
            </div>
          </div>
        `;
      }
    }

    // Initialize Prompt Library and Generative UI
    const promptLibrary = new PromptLibrary();
    const generativeUI = new GenerativeUI();

    // Make globally accessible
    window.promptLibrary = promptLibrary;
    window.generativeUI = generativeUI;

    // Initialize UI Controller
    const ui = new UIController();

    // Make UI instance globally accessible for inline event handlers
    window.ui = ui;

    // Initialize sound manager with saved settings
    soundManager.setEnabled(appState.settings.soundEnabled);

    // Initialize voice manager with saved settings
    voiceManager.setEnabled(appState.settings.voiceEnabled);
    voiceManager.setAutoSpeak(appState.settings.autoSpeak);
    voiceManager.setAzureKey(appState.settings.azureTTSKey);
    voiceManager.setVoiceName(appState.settings.ttsVoiceName);

    // Enhanced keyboard shortcuts (Cycle 1 Feature)
    document.addEventListener("keydown", (e) => {
      const isInputFocused = document.activeElement.tagName === "INPUT" ||
                             document.activeElement.tagName === "TEXTAREA";

      // Escape - close everything
      if (e.key === "Escape") {
        const modals = document.querySelectorAll(".modal.active");
        modals.forEach((modal) => {
          modal.classList.remove("active");
        });

        const promptLibraryModal = document.getElementById("prompt-library-modal");
        if (promptLibraryModal.classList.contains("active")) {
          promptLibrary.close();
        }

        if (document.getElementById("menu-items").classList.contains("open")) {
          ui.closeMenu();
        }

        if (document.getElementById("sidebar").classList.contains("open")) {
          ui.toggleSidebar();
        }

        // Blur input if focused
        if (isInputFocused) {
          document.activeElement.blur();
        }
      }

      // Cmd/Ctrl + K - Focus input
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        document.getElementById("user-input").focus();
      }

      // Cmd/Ctrl + N - New chat
      if ((e.metaKey || e.ctrlKey) && e.key === "n") {
        e.preventDefault();
        ui.createNewChat();
      }

      // Cmd/Ctrl + , - Open settings
      if ((e.metaKey || e.ctrlKey) && e.key === ",") {
        e.preventDefault();
        document.getElementById("settings-modal").classList.add("active");
      }

      // Cmd/Ctrl + P - Open prompt library
      if ((e.metaKey || e.ctrlKey) && e.key === "p") {
        e.preventDefault();
        promptLibrary.open();
      }

      // Cmd/Ctrl + B - Toggle sidebar
      if ((e.metaKey || e.ctrlKey) && e.key === "b") {
        e.preventDefault();
        ui.toggleSidebar();
      }

      // Cmd/Ctrl + D - Toggle dark mode
      if ((e.metaKey || e.ctrlKey) && e.key === "d") {
        e.preventDefault();
        ui.toggleTheme();
      }

      // / - Focus input (when not typing)
      if (e.key === "/" && !isInputFocused) {
        e.preventDefault();
        document.getElementById("user-input").focus();
      }

      // ? - Show keyboard shortcuts hint (when not typing)
      if (e.key === "?" && !isInputFocused) {
        e.preventDefault();
        ui.showNotification(
          "Shortcuts: K Focus | N New | P Prompts | B Sidebar | D Dark | , Settings | / Focus | Esc Close",
          "info",
          5000
        );
      }
    });

    // Add fade out animation
    const style = document.createElement("style");
    style.textContent = `
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    `;
    document.head.appendChild(style);

    // Force load voices for speech synthesis
    if ("speechSynthesis" in window) {
      speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices();
      };
    }
  </script>
</body>

</html>
