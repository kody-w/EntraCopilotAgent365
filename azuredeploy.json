{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "subscriptionId": {
      "type": "String",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "functionAppName": {
      "type": "string",
      "defaultValue": "[concat('copilot365-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of the Function App (must be globally unique)"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat('st', uniqueString(resourceGroup().id))]",
      "maxLength": 24,
      "metadata": {
        "description": "Storage Account Name (3-24 characters, lowercase and numbers only)"
      }
    },
    "storageBlobContainerName": {
      "type": "String",
      "defaultValue": "deployments"
    },
    "openAIServiceName": {
      "type": "string",
      "defaultValue": "[concat('openai-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name for the Azure OpenAI Service"
      }
    },
    "openAIModelName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "allowedValues": [
        "gpt-35-turbo",
        "gpt-4",
        "gpt-4o"
      ],
      "metadata": {
        "description": "Azure OpenAI Model to deploy"
      }
    },
    "openAIDeploymentName": {
      "type": "string",
      "defaultValue": "gpt-deployment",
      "metadata": {
        "description": "Name for the model deployment"
      }
    },
    "openAIDeploymentCapacity": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 300,
      "metadata": {
        "description": "Deployment capacity in thousands of tokens per minute (TPM). Start with 10 and increase if needed based on your quota."
      }
    },
    "assistantName": {
      "type": "string",
      "defaultValue": "Copilot Agent 365",
      "metadata": {
        "description": "Name for the AI Assistant"
      }
    },
    "characteristicDescription": {
      "type": "string",
      "defaultValue": "Enterprise AI assistant integrated with Microsoft 365",
      "metadata": {
        "description": "Description of the assistant's characteristics"
      }
    },
    "openAILocation": {
      "type": "string",
      "allowedValues": [
        "australiaeast",
        "canadaeast",
        "eastus",
        "eastus2",
        "francecentral",
        "japaneast",
        "northcentralus",
        "norwayeast",
        "southcentralus",
        "swedencentral",
        "switzerlandnorth",
        "uksouth",
        "westeurope",
        "westus",
        "westus3"
      ],
      "metadata": {
        "description": "REQUIRED: Select region for Azure OpenAI Service. Choose a region with available quota (different from your resource group region if needed)."
      }
    },
    "pythonVersion": {
      "type": "string",
      "defaultValue": "3.11",
      "allowedValues": [
        "3.11"
      ],
      "metadata": {
        "description": "Python version to use (3.11 required for Azure Functions v4 compatibility)"
      }
    },
    "functionAppRuntime": {
      "type": "string",
      "defaultValue": "python",
      "metadata": {
        "description": "Runtime for Function App"
      }
    }
  },
  "variables": {
    "fileShareName": "[concat('azf', parameters('functionAppName'), uniqueString(resourceGroup().id))]",
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
    "openAIResourceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('openAIServiceName'))]",
    "functionAppId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
    "appServicePlanName": "[concat('asp-', parameters('functionAppName'))]",
    "appInsightsName": "[concat('ai-', parameters('functionAppName'))]",
    "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "storageFileDataSmbShareContributorRoleId": "0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-05-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2",
        "defaultToOAuthAuthentication": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": false,
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2022-05-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', variables('fileShareName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-05-01",
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('storageBlobContainerName'))]",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[parameters('openAIServiceName')]",
      "location": "[parameters('openAILocation')]",
      "sku": {
        "name": "S0"
      },
      "kind": "OpenAI",
      "properties": {
        "customSubDomainName": "[parameters('openAIServiceName')]",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts/deployments",
      "apiVersion": "2023-05-01",
      "name": "[concat(parameters('openAIServiceName'), '/', parameters('openAIDeploymentName'))]",
      "dependsOn": [
        "[variables('openAIResourceId')]"
      ],
      "sku": {
        "name": "Standard",
        "capacity": "[parameters('openAIDeploymentCapacity')]"
      },
      "properties": {
        "model": {
          "format": "OpenAI",
          "name": "[parameters('openAIModelName')]",
          "version": "2024-08-06"
        },
        "versionUpgradeOption": "OnceNewDefaultVersionAvailable",
        "raiPolicyName": "Microsoft.Default"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('appInsightsName')]",
      "location": "[resourceGroup().location]",
      "kind": "web",
      "properties": {
        "Application_Type": "web"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[variables('appServicePlanName')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "tier": "FlexConsumption",
        "name": "FC1"
      },
      "kind": "functionapp",
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('functionAppName')]",
      "location": "[resourceGroup().location]",
      "kind": "functionapp,linux",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "[variables('storageAccountId')]",
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), 'default', parameters('storageBlobContainerName'))]",
        "[variables('openAIResourceId')]",
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      ],
      "tags": {
        "hidden-link: /app-insights-resource-id": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
        "httpsOnly": true,
        "functionAppConfig": {
          "deployment": {
            "storage": {
              "type": "blobContainer",
              "value": "[concat('https://', parameters('storageAccountName'), '.blob.core.windows.net/', parameters('storageBlobContainerName'))]",
              "authentication": {
                "type": "SystemAssignedIdentity"
              }
            }
          },
          "scaleAndConcurrency": {
            "maximumInstanceCount": 100,
            "instanceMemoryMB": 2048
          },
          "runtime": {
            "name": "python",
            "version": "[parameters('pythonVersion')]"
          }
        },
        "siteConfig": {
          "appSettings": [
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName'))).ConnectionString]"
            },
            {
              "name": "AzureWebJobsStorage__accountName",
              "value": "[parameters('storageAccountName')]"
            },
            {
              "name": "AZURE_OPENAI_API_KEY",
              "value": "[listKeys(variables('openAIResourceId'), '2023-05-01').key1]"
            },
            {
              "name": "AZURE_OPENAI_ENDPOINT",
              "value": "[reference(variables('openAIResourceId')).endpoint]"
            },
            {
              "name": "AZURE_OPENAI_API_VERSION",
              "value": "2024-02-01"
            },
            {
              "name": "AZURE_OPENAI_DEPLOYMENT_NAME",
              "value": "[parameters('openAIDeploymentName')]"
            },
            {
              "name": "AZURE_STORAGE_ACCOUNT_NAME",
              "value": "[parameters('storageAccountName')]"
            },
            {
              "name": "AZURE_FILES_SHARE_NAME",
              "value": "[variables('fileShareName')]"
            },
            {
              "name": "ASSISTANT_NAME",
              "value": "[parameters('assistantName')]"
            },
            {
              "name": "CHARACTERISTIC_DESCRIPTION",
              "value": "[parameters('characteristicDescription')]"
            }
          ]
        }
      }
    },
    {
      "comments": "Storage Blob Data Contributor role for Function App Managed Identity",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(parameters('storageAccountName'), parameters('functionAppName'), variables('storageBlobDataContributorRoleId'))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
      "dependsOn": [
        "[variables('functionAppId')]",
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
        "principalId": "[reference(variables('functionAppId'), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "comments": "Storage File Data SMB Share Contributor role for Function App Managed Identity",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(parameters('storageAccountName'), parameters('functionAppName'), variables('storageFileDataSmbShareContributorRoleId'))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
      "dependsOn": [
        "[variables('functionAppId')]",
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageFileDataSmbShareContributorRoleId'))]",
        "principalId": "[reference(variables('functionAppId'), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "comments": "Storage File Data Privileged Contributor role for Function App Managed Identity (required for Azure Files token auth)",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(parameters('storageAccountName'), parameters('functionAppName'), '69566ab7-960f-475b-8e7c-b3118f30c6bd')]",
      "scope": "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
      "dependsOn": [
        "[variables('functionAppId')]",
        "[variables('storageAccountId')]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '69566ab7-960f-475b-8e7c-b3118f30c6bd')]",
        "principalId": "[reference(variables('functionAppId'), '2023-12-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      }
    }
  ],
  "outputs": {
    "functionAppName": {
      "type": "string",
      "value": "[parameters('functionAppName')]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[concat('https://', reference(variables('functionAppId')).defaultHostName)]"
    },
    "functionEndpoint": {
      "type": "string",
      "value": "[concat('https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function')]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[reference(variables('openAIResourceId')).endpoint]"
    },
    "openAIKey": {
      "type": "string",
      "value": "[listKeys(variables('openAIResourceId'), '2023-05-01').key1]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[parameters('storageAccountName')]"
    },
    "fileShareName": {
      "type": "string",
      "value": "[variables('fileShareName')]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "managedIdentityPrincipalId": {
      "type": "string",
      "value": "[reference(variables('functionAppId'), '2023-12-01', 'Full').identity.principalId]"
    },
    "localSettingsJson": {
      "type": "string",
      "value": "[concat('{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"AzureWebJobsStorage__accountName\": \"', parameters('storageAccountName'), '\",\n    \"AZURE_OPENAI_API_KEY\": \"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\",\n    \"AZURE_OPENAI_ENDPOINT\": \"', reference(variables('openAIResourceId')).endpoint, '\",\n    \"AZURE_OPENAI_API_VERSION\": \"2024-02-01\",\n    \"AZURE_OPENAI_DEPLOYMENT_NAME\": \"', parameters('openAIDeploymentName'), '\",\n    \"AZURE_STORAGE_ACCOUNT_NAME\": \"', parameters('storageAccountName'), '\",\n    \"AZURE_FILES_SHARE_NAME\": \"', variables('fileShareName'), '\",\n    \"ASSISTANT_NAME\": \"', parameters('assistantName'), '\",\n    \"CHARACTERISTIC_DESCRIPTION\": \"', parameters('characteristicDescription'), '\"\n  }\n}')]"
    },
    "getFunctionKeyInstructions": {
      "type": "string",
      "value": "[concat('To get your Function Key:\n1. Go to Azure Portal\n2. Navigate to Function App: ', parameters('functionAppName'), '\n3. Click \"App keys\" in left menu\n4. Copy the \"default\" key under \"Host keys\"\n\nOr use Azure CLI:\naz functionapp keys list --name ', parameters('functionAppName'), ' --resource-group ', resourceGroup().name, ' --query \"functionKeys.default\" -o tsv')]"
    },
    "windowsSetupScript": {
      "type": "string",
      "value": "[concat('# Copilot Agent 365 - Windows Setup Script\n# Generated from ARM deployment\n# Run this script in PowerShell to configure your local environment\n\n$ErrorActionPreference = \"Stop\"\n\nWrite-Host \"========================================\" -ForegroundColor Cyan\nWrite-Host \"Copilot Agent 365 - Local Setup\" -ForegroundColor Cyan\nWrite-Host \"========================================\" -ForegroundColor Cyan\n\n# Configuration from deployment\n$FUNCTION_APP_NAME = \"', parameters('functionAppName'), '\"\n$RESOURCE_GROUP = \"', resourceGroup().name, '\"\n$SUBSCRIPTION_ID = \"', subscription().subscriptionId, '\"\n$OPENAI_ENDPOINT = \"', reference(variables('openAIResourceId')).endpoint, '\"\n$OPENAI_KEY = \"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\"\n$OPENAI_DEPLOYMENT = \"', parameters('openAIDeploymentName'), '\"\n$STORAGE_ACCOUNT = \"', parameters('storageAccountName'), '\"\n$FILE_SHARE = \"', variables('fileShareName'), '\"\n$ASSISTANT_NAME = \"', parameters('assistantName'), '\"\n$CHARACTERISTIC_DESC = \"', parameters('characteristicDescription'), '\"\n$FUNCTION_URL = \"https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function\"\n$REPO_URL = \"https://github.com/kody-w/EntraCopilotAgent365.git\"\n\n# Check prerequisites\nWrite-Host \"\"\nWrite-Host \"Checking prerequisites...\" -ForegroundColor Yellow\n$missingTools = @()\n\n# Check Git\ntry {\n    $gitVersion = git --version 2>$null\n    Write-Host \"[OK] $gitVersion\" -ForegroundColor Green\n} catch {\n    $missingTools += \"git\"\n    Write-Host \"[X] Git not found\" -ForegroundColor Red\n}\n\n# Check Python\ntry {\n    $pyVersion = python --version 2>$null\n    Write-Host \"[OK] $pyVersion\" -ForegroundColor Green\n} catch {\n    $missingTools += \"python\"\n    Write-Host \"[X] Python not found\" -ForegroundColor Red\n}\n\n# Check Azure Functions Core Tools\ntry {\n    $funcVersion = func --version 2>$null\n    Write-Host \"[OK] Azure Functions Core Tools $funcVersion\" -ForegroundColor Green\n} catch {\n    $missingTools += \"azure-functions-core-tools\"\n    Write-Host \"[X] Azure Functions Core Tools not found\" -ForegroundColor Red\n}\n\n# Check Azure CLI\ntry {\n    $azVersion = az --version 2>$null | Select-Object -First 1\n    Write-Host \"[OK] Azure CLI installed\" -ForegroundColor Green\n} catch {\n    $missingTools += \"azure-cli\"\n    Write-Host \"[X] Azure CLI not found\" -ForegroundColor Red\n}\n\n# If missing tools, show install instructions\nif ($missingTools.Count -gt 0) {\n    Write-Host \"\"\n    Write-Host \"Missing required tools: $($missingTools -join \", \")\" -ForegroundColor Red\n    Write-Host \"\"\n    Write-Host \"Install instructions:\" -ForegroundColor Yellow\n    Write-Host \"  winget install Git.Git\" -ForegroundColor White\n    Write-Host \"  winget install Python.Python.3.11\" -ForegroundColor White\n    Write-Host \"  winget install Microsoft.AzureCLI\" -ForegroundColor White\n    Write-Host \"  winget install Microsoft.Azure.FunctionsCoreTools\" -ForegroundColor White\n    Write-Host \"\"\n    $continue = Read-Host \"Do you want to continue anyway? (y/N)\"\n    if ($continue -ne \"y\" -and $continue -ne \"Y\") {\n        exit 1\n    }\n}\n\n# Check Azure CLI login\nWrite-Host \"\"\nWrite-Host \"Checking Azure CLI login (required for local storage access)...\" -ForegroundColor Yellow\n$azAccount = az account show 2>$null | ConvertFrom-Json\nif (-not $azAccount) {\n    Write-Host \"[X] Not logged into Azure CLI\" -ForegroundColor Red\n    Write-Host \"Running: az login\" -ForegroundColor Yellow\n    az login\n    $azAccount = az account show | ConvertFrom-Json\n}\nWrite-Host \"[OK] Logged in as: $($azAccount.user.name)\" -ForegroundColor Green\n$USER_OBJECT_ID = (az ad signed-in-user show --query id -o tsv)\nWrite-Host \"[OK] User Object ID: $USER_OBJECT_ID\" -ForegroundColor Green\n\n# Assign Storage File Data Privileged Contributor role for local dev\nWrite-Host \"\"\nWrite-Host \"Assigning storage role for local development...\" -ForegroundColor Yellow\nWrite-Host \"Role: Storage File Data Privileged Contributor\" -ForegroundColor White\ntry {\n    az role assignment create --assignee $USER_OBJECT_ID --role \"Storage File Data Privileged Contributor\" --scope \"/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT\" 2>$null\n    Write-Host \"[OK] Role assigned successfully\" -ForegroundColor Green\n} catch {\n    Write-Host \"[!] Role assignment via CLI failed - assign manually via Azure Portal:\" -ForegroundColor Yellow\n    Write-Host \"    1. Go to Azure Portal > Storage Accounts > $STORAGE_ACCOUNT\" -ForegroundColor White\n    Write-Host \"    2. Click Access Control (IAM) in left menu\" -ForegroundColor White\n    Write-Host \"    3. Click + Add > Add role assignment\" -ForegroundColor White\n    Write-Host \"    4. Search for: Storage File Data Privileged Contributor\" -ForegroundColor White\n    Write-Host \"    5. Click Next > + Select members\" -ForegroundColor White\n    Write-Host \"    6. Search for your email/name and select it\" -ForegroundColor White\n    Write-Host \"    7. Click Review + assign\" -ForegroundColor White\n}\n\n# Clone the repository\nWrite-Host \"\"\nWrite-Host \"Cloning repository...\" -ForegroundColor Yellow\nif (Test-Path \"EntraCopilotAgent365\") {\n    Write-Host \"Directory already exists, pulling latest...\" -ForegroundColor Yellow\n    Set-Location EntraCopilotAgent365\n    git pull\n} else {\n    git clone $REPO_URL\n    Set-Location EntraCopilotAgent365\n}\n\n# Create virtual environment\nWrite-Host \"\"\nWrite-Host \"Creating Python virtual environment...\" -ForegroundColor Yellow\nif (-not (Test-Path \".venv\")) {\n    python -m venv .venv\n}\n\n# Activate and install dependencies\nWrite-Host \"Installing dependencies...\" -ForegroundColor Yellow\n.venv\\Scripts\\Activate.ps1\npip install --upgrade pip\npip install -r requirements.txt\n\nWrite-Host \"\"\nWrite-Host \"Creating local.settings.json (token-based auth)...\" -ForegroundColor Yellow\n\n$localSettings = @{\n    IsEncrypted = $false\n    Values = @{\n        FUNCTIONS_WORKER_RUNTIME = \"python\"\n        \"AzureWebJobsStorage__accountName\" = $STORAGE_ACCOUNT\n        AZURE_OPENAI_API_KEY = $OPENAI_KEY\n        AZURE_OPENAI_ENDPOINT = $OPENAI_ENDPOINT\n        AZURE_OPENAI_API_VERSION = \"2024-02-01\"\n        AZURE_OPENAI_DEPLOYMENT_NAME = $OPENAI_DEPLOYMENT\n        AZURE_STORAGE_ACCOUNT_NAME = $STORAGE_ACCOUNT\n        AZURE_FILES_SHARE_NAME = $FILE_SHARE\n        ASSISTANT_NAME = $ASSISTANT_NAME\n        CHARACTERISTIC_DESCRIPTION = $CHARACTERISTIC_DESC\n    }\n}\n\n$localSettings | ConvertTo-Json -Depth 10 | Set-Content -Path \"local.settings.json\" -Encoding UTF8\nWrite-Host \"local.settings.json created successfully!\" -ForegroundColor Green\n\n# Deploy to Azure\nWrite-Host \"\"\nWrite-Host \"Deploying to Azure Function App...\" -ForegroundColor Yellow\ntry {\n    func azure functionapp publish $FUNCTION_APP_NAME\n} catch {\n    Write-Host \"Skipping deployment - Azure Functions Core Tools not installed\" -ForegroundColor Red\n    Write-Host \"Run manually: func azure functionapp publish $FUNCTION_APP_NAME\" -ForegroundColor Yellow\n}\n\nWrite-Host \"\"\nWrite-Host \"========================================\" -ForegroundColor Green\nWrite-Host \"Setup Complete!\" -ForegroundColor Green\nWrite-Host \"========================================\" -ForegroundColor Green\nWrite-Host \"\"\nWrite-Host \"Function App Name: $FUNCTION_APP_NAME\" -ForegroundColor White\nWrite-Host \"Resource Group: $RESOURCE_GROUP\" -ForegroundColor White\nWrite-Host \"Function URL: $FUNCTION_URL\" -ForegroundColor White\nWrite-Host \"\"\nWrite-Host \"LOCAL DEV NOTES:\" -ForegroundColor Cyan\nWrite-Host \"- Storage uses token auth (no connection strings)\" -ForegroundColor White\nWrite-Host \"- Keep Azure CLI logged in: az login\" -ForegroundColor White\nWrite-Host \"- Your user has Storage File Data Privileged Contributor role\" -ForegroundColor White\nWrite-Host \"\"\nWrite-Host \"NEXT STEP: Get your Function Key from Azure Portal:\" -ForegroundColor Yellow\nWrite-Host \"1. Go to Azure Portal\" -ForegroundColor White\nWrite-Host \"2. Navigate to Function App: $FUNCTION_APP_NAME\" -ForegroundColor White\nWrite-Host \"3. Click App keys in left menu\" -ForegroundColor White\nWrite-Host \"4. Copy the default key under Host keys\" -ForegroundColor White\nWrite-Host \"\"\nWrite-Host \"Or run: az functionapp keys list --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP --query functionKeys.default -o tsv\" -ForegroundColor Cyan\nWrite-Host \"\"\nWrite-Host \"To run locally: .\\\\run.ps1\" -ForegroundColor Yellow\n')]"
    },
    "macLinuxSetupScript": {
      "type": "string",
      "value": "[concat('#!/bin/bash\n# Copilot Agent 365 - Mac/Linux Setup Script\n# Generated from ARM deployment\n# Run: chmod +x setup.sh && ./setup.sh\n\nset -e\n\nRED=\"\\033[0;31m\"\nGREEN=\"\\033[0;32m\"\nYELLOW=\"\\033[1;33m\"\nBLUE=\"\\033[0;34m\"\nCYAN=\"\\033[0;36m\"\nNC=\"\\033[0m\"\n\necho -e \"${BLUE}========================================${NC}\"\necho -e \"${BLUE}Copilot Agent 365 - Local Setup${NC}\"\necho -e \"${BLUE}========================================${NC}\"\n\n# Configuration from deployment\nFUNCTION_APP_NAME=\"', parameters('functionAppName'), '\"\nRESOURCE_GROUP=\"', resourceGroup().name, '\"\nSUBSCRIPTION_ID=\"', subscription().subscriptionId, '\"\nOPENAI_ENDPOINT=\"', reference(variables('openAIResourceId')).endpoint, '\"\nOPENAI_KEY=\"', listKeys(variables('openAIResourceId'), '2023-05-01').key1, '\"\nOPENAI_DEPLOYMENT=\"', parameters('openAIDeploymentName'), '\"\nSTORAGE_ACCOUNT=\"', parameters('storageAccountName'), '\"\nFILE_SHARE=\"', variables('fileShareName'), '\"\nASSISTANT_NAME=\"', parameters('assistantName'), '\"\nCHARACTERISTIC_DESC=\"', parameters('characteristicDescription'), '\"\nFUNCTION_URL=\"https://', reference(variables('functionAppId')).defaultHostName, '/api/businessinsightbot_function\"\nREPO_URL=\"https://github.com/kody-w/EntraCopilotAgent365.git\"\n\n# Detect OS\ndetect_os() {\n    if [[ \"$OSTYPE\" == \"darwin\"* ]]; then\n        echo \"macos\"\n    elif [[ \"$OSTYPE\" == \"linux-gnu\"* ]]; then\n        echo \"linux\"\n    else\n        echo \"unknown\"\n    fi\n}\n\nOS_TYPE=$(detect_os)\necho -e \"${YELLOW}Detected OS: $OS_TYPE${NC}\"\n\n# Check for required tools\necho \"\"\necho -e \"${YELLOW}Checking prerequisites...${NC}\"\n\nMISSING_TOOLS=()\n\n# Check Git\nif ! command -v git &> /dev/null; then\n    MISSING_TOOLS+=(\"git\")\n    echo -e \"${RED}[X] Git not found${NC}\"\nelse\n    echo -e \"${GREEN}[OK] Git $(git --version | cut -d\" \" -f3)${NC}\"\nfi\n\n# Check Python\nPYTHON_CMD=\"\"\nif command -v python3 &> /dev/null; then\n    PYTHON_CMD=\"python3\"\nelif command -v python &> /dev/null; then\n    PYTHON_CMD=\"python\"\nfi\n\nif [ -z \"$PYTHON_CMD\" ]; then\n    MISSING_TOOLS+=(\"python3\")\n    echo -e \"${RED}[X] Python not found${NC}\"\nelse\n    PY_VERSION=$($PYTHON_CMD --version 2>&1 | cut -d\" \" -f2)\n    echo -e \"${GREEN}[OK] Python $PY_VERSION${NC}\"\nfi\n\n# Check pip\nif ! command -v pip3 &> /dev/null && ! command -v pip &> /dev/null; then\n    MISSING_TOOLS+=(\"pip\")\n    echo -e \"${RED}[X] pip not found${NC}\"\nelse\n    echo -e \"${GREEN}[OK] pip installed${NC}\"\nfi\n\n# Check Azure Functions Core Tools\nif ! command -v func &> /dev/null; then\n    MISSING_TOOLS+=(\"azure-functions-core-tools\")\n    echo -e \"${RED}[X] Azure Functions Core Tools not found${NC}\"\nelse\n    FUNC_VERSION=$(func --version 2>/dev/null || echo \"unknown\")\n    echo -e \"${GREEN}[OK] Azure Functions Core Tools $FUNC_VERSION${NC}\"\nfi\n\n# Check Azure CLI\nif ! command -v az &> /dev/null; then\n    MISSING_TOOLS+=(\"azure-cli\")\n    echo -e \"${RED}[X] Azure CLI not found${NC}\"\nelse\n    AZ_VERSION=$(az --version 2>/dev/null | head -1 | cut -d\" \" -f2)\n    echo -e \"${GREEN}[OK] Azure CLI $AZ_VERSION${NC}\"\nfi\n\n# If missing tools, show install instructions\nif [ ${#MISSING_TOOLS[@]} -gt 0 ]; then\n    echo \"\"\n    echo -e \"${RED}Missing required tools: ${MISSING_TOOLS[*]}${NC}\"\n    echo \"\"\n    echo -e \"${YELLOW}Install instructions:${NC}\"\n    if [[ \"$OS_TYPE\" == \"macos\" ]]; then\n        echo \"  brew install git python azure-cli azure-functions-core-tools@4\"\n    else\n        echo \"  # Install Git and Python\"\n        echo \"  sudo apt-get update && sudo apt-get install -y git python3 python3-pip python3-venv\"\n        echo \"  # Install Azure CLI: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-linux\"\n        echo \"  # Install Azure Functions Core Tools: https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local\"\n    fi\n    echo \"\"\n    read -p \"Do you want to continue anyway? (y/N) \" -n 1 -r\n    echo\n    if [[ ! $REPLY =~ ^[Yy]$ ]]; then\n        exit 1\n    fi\nfi\n\n# Check Azure CLI login\necho \"\"\necho -e \"${YELLOW}Checking Azure CLI login (required for local storage access)...${NC}\"\nif ! az account show &> /dev/null; then\n    echo -e \"${RED}[X] Not logged into Azure CLI${NC}\"\n    echo -e \"${YELLOW}Running: az login${NC}\"\n    az login\nfi\nAZ_USER=$(az account show --query user.name -o tsv)\necho -e \"${GREEN}[OK] Logged in as: $AZ_USER${NC}\"\nUSER_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv)\necho -e \"${GREEN}[OK] User Object ID: $USER_OBJECT_ID${NC}\"\n\n# Assign Storage File Data Privileged Contributor role for local dev\necho \"\"\necho -e \"${YELLOW}Assigning storage role for local development...${NC}\"\necho \"Role: Storage File Data Privileged Contributor\"\nif az role assignment create --assignee \"$USER_OBJECT_ID\" --role \"Storage File Data Privileged Contributor\" --scope \"/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT\" 2>/dev/null; then\n    echo -e \"${GREEN}[OK] Role assigned successfully${NC}\"\nelse\n    echo -e \"${YELLOW}[!] Role assignment via CLI failed - assign manually via Azure Portal:${NC}\"\n    echo \"    1. Go to Azure Portal > Storage Accounts > $STORAGE_ACCOUNT\"\n    echo \"    2. Click Access Control (IAM) in left menu\"\n    echo \"    3. Click + Add > Add role assignment\"\n    echo \"    4. Search for: Storage File Data Privileged Contributor\"\n    echo \"    5. Click Next > + Select members\"\n    echo \"    6. Search for your email/name and select it\"\n    echo \"    7. Click Review + assign\"\nfi\n\n# Clone the repository\necho \"\"\necho -e \"${YELLOW}Cloning repository...${NC}\"\nif [ -d \"EntraCopilotAgent365\" ]; then\n    echo \"Directory already exists, pulling latest...\"\n    cd EntraCopilotAgent365\n    git pull\nelse\n    git clone $REPO_URL\n    cd EntraCopilotAgent365\nfi\n\n# Create virtual environment\necho \"\"\necho -e \"${YELLOW}Creating Python virtual environment...${NC}\"\nif [ ! -d \".venv\" ]; then\n    $PYTHON_CMD -m venv .venv\nfi\n\n# Activate and install dependencies\necho -e \"${YELLOW}Installing dependencies...${NC}\"\nsource .venv/bin/activate\npip install --upgrade pip\npip install -r requirements.txt\n\necho \"\"\necho -e \"${YELLOW}Creating local.settings.json (token-based auth)...${NC}\"\n\ncat > local.settings.json << EOF\n{\n  \"IsEncrypted\": false,\n  \"Values\": {\n    \"FUNCTIONS_WORKER_RUNTIME\": \"python\",\n    \"AzureWebJobsStorage__accountName\": \"$STORAGE_ACCOUNT\",\n    \"AZURE_OPENAI_API_KEY\": \"$OPENAI_KEY\",\n    \"AZURE_OPENAI_ENDPOINT\": \"$OPENAI_ENDPOINT\",\n    \"AZURE_OPENAI_API_VERSION\": \"2024-02-01\",\n    \"AZURE_OPENAI_DEPLOYMENT_NAME\": \"$OPENAI_DEPLOYMENT\",\n    \"AZURE_STORAGE_ACCOUNT_NAME\": \"$STORAGE_ACCOUNT\",\n    \"AZURE_FILES_SHARE_NAME\": \"$FILE_SHARE\",\n    \"ASSISTANT_NAME\": \"$ASSISTANT_NAME\",\n    \"CHARACTERISTIC_DESCRIPTION\": \"$CHARACTERISTIC_DESC\"\n  }\n}\nEOF\n\necho -e \"${GREEN}local.settings.json created successfully!${NC}\"\n\n# Deploy to Azure\necho \"\"\necho -e \"${YELLOW}Deploying to Azure Function App...${NC}\"\nif command -v func &> /dev/null; then\n    func azure functionapp publish $FUNCTION_APP_NAME\nelse\n    echo -e \"${RED}Skipping deployment - Azure Functions Core Tools not installed${NC}\"\n    echo \"Run manually: func azure functionapp publish $FUNCTION_APP_NAME\"\nfi\n\necho \"\"\necho -e \"${GREEN}========================================${NC}\"\necho -e \"${GREEN}Setup Complete!${NC}\"\necho -e \"${GREEN}========================================${NC}\"\necho \"\"\necho \"Function App Name: $FUNCTION_APP_NAME\"\necho \"Resource Group: $RESOURCE_GROUP\"\necho \"Function URL: $FUNCTION_URL\"\necho \"\"\necho -e \"${CYAN}LOCAL DEV NOTES:${NC}\"\necho \"- Storage uses token auth (no connection strings)\"\necho \"- Keep Azure CLI logged in: az login\"\necho \"- Your user has Storage File Data Privileged Contributor role\"\necho \"\"\necho -e \"${YELLOW}NEXT STEP: Get your Function Key from Azure Portal:${NC}\"\necho \"1. Go to Azure Portal\"\necho \"2. Navigate to Function App: $FUNCTION_APP_NAME\"\necho \"3. Click App keys in left menu\"\necho \"4. Copy the default key under Host keys\"\necho \"\"\necho \"Or run: az functionapp keys list --name $FUNCTION_APP_NAME --resource-group $RESOURCE_GROUP --query functionKeys.default -o tsv\"\necho \"\"\necho \"To run locally: ./run.sh\"\n')]"
    }
  }
}
